<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Saju‚ÄëEight ‚Ä¢ End‚Äëto‚ÄëEnd Playground</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1220;--panel:#121a2a;--muted:#8aa0c3;--txt:#ecf2ff;--accent:#66b3ff;--ok:#49d39a;--err:#ff7a7a}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(120deg,#0b1220,#0e2342);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,Arial}
.wrap{max-width:1060px;margin:28px auto 80px;padding:0 18px}
.h1{font-size:26px;font-weight:800;margin:6px 0 8px}
.sub{color:var(--muted);margin-bottom:18px}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);margin-top:12px}
.section-title{font-size:12px;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin:0 0 8px}
.row{display:flex;gap:10px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
select,button,input{background:#0b1426;color:var(--txt);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;outline:none}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px #66b3ff33}
button{background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:800;border:none;cursor:pointer}
button[disabled]{opacity:.6;cursor:not-allowed}
.help{color:var(--muted);font-size:13px;margin-top:6px}
/* pillars */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pcard{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
.ptitle{font-size:12px;color:#a9bce3;margin-bottom:6px;text-align:center}
.box{height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:800;border:1px solid #0003}
.subline{font-size:11px;color:#cfe4ff;text-align:center;margin-top:6px}
.wood{background:#16a34a;color:#fff}.fire{background:#ef4444;color:#fff}
.earth{background:#f59e0b;color:#111}.metal{background:#e5e7eb;color:#111;border-color:#cbd5e1}
.water{background:#06b6d4;color:#fff}
/* big luck */
.luckbar{display:flex;gap:8px}
.lseg{flex:1;min-width:84px;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:rgba(255,255,255,.05)}
.lh{font-size:12px;opacity:.85;margin-bottom:2px}
.lgan{font-weight:800}
.lnow{outline:2px solid var(--accent);box-shadow:0 0 0 4px #66b3ff33}
/* reading */
.block{background:#14213d;border:1px solid #2c4168;border-radius:10px;padding:12px;margin-top:10px}
.btitle{color:#a9d6ff;font-weight:800;margin-bottom:6px}
.bsubtitle{color:#9dc6ff;font-size:12px;margin:-2px 0 8px;opacity:.9}
.bul{padding-left:18px;margin:6px 0}
.call{margin-top:10px;padding:10px 12px;background:#49d39a18;border:1px solid #49d39a55;border-radius:10px}
/* fortunes */
.fgrid{display:grid;grid-template-columns:1fr;gap:10px}
.ftile{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
.ftop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.fleft{display:flex;align-items:center;gap:10px}
.ficon{font-size:24px}
.fname{font-weight:700}
.fhint{font-size:12px;color:var(--muted)}
.fcontent{margin-top:10px;display:none}
.closewrap{display:flex;justify-content:flex-end}
.closebtn{margin-top:16px;background:#22314c;border:1px solid #2c4168;color:#cfe2ff;padding:8px 10px;border-radius:8px}
/* fortune article */
.f-article h4{margin:0 0 8px;font-size:16px}
.f-article .sub{margin:0 0 10px;color:#9dc6ff}
.f-article p{margin:8px 0 10px;line-height:1.6}
.f-article ul{margin:8px 0 12px 18px}
.f-article li{margin:4px 0}
.f-article hr{border:none;border-top:1px solid #2c4168;margin:12px 0}
/* chat */
.chat{background:#0f1a30;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;height:220px;overflow:auto}
.msg{max-width:78%;padding:10px 12px;border-radius:10px;line-height:1.45;font-size:14px}
.me{align-self:flex-end;background:#3a86ff;color:#081326}
.bot{align-self:flex-start;background:#14213d;border:1px solid #2c4168}
.inputrow{display:flex;gap:8px;margin-top:8px}
.text{flex:1}
.small{font-size:12px;color:var(--muted)}
.err{color:var(--err)}.ok{color:var(--ok)}
@media(min-width:760px){.grid2{grid-template-columns:repeat(5,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">Saju‚ÄëEight ‚Ä¢ End‚Äëto‚ÄëEnd Playground</div>
  <div class="sub">Enter birth info ‚Üí timezone ‚Üí pillars ‚Üí 7‚Äësection reading ‚Üí explore specific fortunes ‚Üí ask follow‚Äëups (with chart context).</div>

  <div class="card">
    <div class="grid2">
      <select id="yy"></select>
      <select id="mm"></select>
      <select id="dd"></select>
      <select id="hh"></select>
      <select id="min"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="city" class="text" placeholder="Seoul / New York / Tokyo"/>
      <button id="run">Calculate & Generate</button>
      <button id="fill" type="button">Fill Example</button>
    </div>
    <div id="status" class="help"></div>
  </div>

  <div class="card">
    <div class="section-title">Four Pillars</div>
    <div id="pillars" class="pillars"></div>
  </div>

  <div class="card">
    <div class="section-title">Big Luck (10‚Äëyear cycles)</div>
    <div id="luck" class="luckbar"></div>
  </div>

  <div class="card">
    <div class="section-title">Reading</div>
    <div id="reading"></div>
  </div>

  <div class="card">
    <div class="section-title">Explore Specific Fortunes</div>
    <div id="fgrid" class="fgrid"></div>
  </div>

  <div class="card">
    <div class="section-title">Ask About Your Saju</div>
    <div id="chat" class="chat"></div>
    <div class="inputrow">
      <input id="ask" class="text" placeholder="Type your question‚Ä¶"/>
      <button id="askBtn">Ask</button>
    </div>
    <div class="small">I‚Äôll use your current chart as context.</div>
  </div>

  <details class="card">
    <summary>Debug JSON (geo/calc/reading)</summary>
    <pre id="dbg" style="white-space:pre-wrap"></pre>
  </details>
</div>

<script>
/* ---------- util ---------- */
const Q = (s)=>document.querySelector(s);
const S = (s)=>document.querySelectorAll(s);
const statusEl = Q('#status'), dbgEl=Q('#dbg');

function setStatus(msg,type=''){ statusEl.textContent=msg; statusEl.className='help '+(type||''); }

async function fetchJSON(url,opt){
  try{
    const r=await fetch(url,opt); const txt=await r.text();
    let data=null; try{ data=JSON.parse(txt) }catch{}
    return { ok:r.ok && !!data, status:r.status, data, raw:txt };
  }catch(e){ return { ok:false, status:0, data:null, raw:String(e&&e.message||e) }; }
}
function yyyy(n){return String(n).padStart(4,'0')}
function dd(n){return String(n).padStart(2,'0')}
function age(b){const d=new Date(b+"T00:00:00");const n=new Date();let a=n.getFullYear()-d.getFullYear();const m=n.getMonth()-d.getMonth(); if(m<0||(m===0&&n.getDate()<d.getDate())) a--; return a;}

(function initSelects(){
  const y=Q('#yy'), m=Q('#mm'), d=Q('#dd'), h=Q('#hh'), mi=Q('#min');
  for(let i=1940;i<=2025;i++) y.appendChild(new Option(i,i));
  for(let i=1;i<=12;i++) m.appendChild(new Option(dd(i),dd(i)));
  for(let i=1;i<=31;i++) d.appendChild(new Option(dd(i),dd(i)));
  for(let i=0;i<24;i++) h.appendChild(new Option(dd(i),dd(i)));
  for(let i=0;i<60;i+=5) mi.appendChild(new Option(dd(i),dd(i)));
  y.value='1989'; m.value='10'; d.value='20'; h.value='06'; mi.value='00';
})();
</script>

<script>
/* ---------- safe markdown / fortune-md ---------- */
function escapeHtml(s){ return s.replace(/[&<>]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[c])); }

function mdFortuneBlock(input=''){
  // 1) normalize line breaks
  let t = (typeof input==='string'?input:String(input||'')).replace(/\r\n/g,'\n').trim();

  // 2) bullet normalization
  // turn lines starting with "‚Ä¢ " or "- " to <li>
  const paragraphs = t.split(/\n{2,}/).map(seg=>{
    // if this paragraph looks like a list:
    if (/^(?:\s*(?:‚Ä¢|-)\s.+\n?)+$/m.test(seg)) {
      const lis = seg.split(/\n/).map(l=>l.trim()).filter(Boolean)
        .map(l=>l.replace(/^(?:‚Ä¢|-)\s*/, ''))
        .map(txt=>`<li>${escapeHtml(txt)}</li>`).join('');
      return `<ul>${lis}</ul>`;
    }
    // otherwise treat single \n as <br>
    const html = escapeHtml(seg).replace(/\n/g,'<br>');
    return `<p>${html}</p>`;
  });

  return paragraphs.join('');
}
</script>

<script>
/* ---------- pillars & luck (unchanged) ---------- */
const STEM_ELEM = {Áî≤:"wood",‰πô:"wood",‰∏ô:"fire",‰∏Å:"fire",Êàä:"earth",Â∑±:"earth",Â∫ö:"metal",Ëæõ:"metal",Â£¨:"water",Áô∏:"water"};
const BRANCH_ELEM={Â≠ê:"water",‰∏ë:"earth",ÂØÖ:"wood",ÂçØ:"wood",Ëæ∞:"earth",Â∑≥:"fire",Âçà:"fire",Êú™:"earth",Áî≥:"metal",ÈÖâ:"metal",Êàå:"earth",‰∫•:"water"};
const colorCls = ch => (STEM_ELEM[ch]||BRANCH_ELEM[ch]||'wood');

function renderPillars(pillars, tenGods){
  const root=Q('#pillars'); root.innerHTML='';
  (['hour','day','month','year']).forEach(k=>{
    const p=pillars?.[k]; if(!p) return;
    const god = (tenGods?.byPillar?.[k] || tenGods?.[k] || '');
    const title = k==='day'?'Day Pillar (ÏùºÏ£º) ¬∑ Day Master'
                : k==='hour'?'Hour Pillar (ÏãúÏ£º)'
                : k==='month'?'Month Pillar (ÏõîÏ£º)'
                : 'Year Pillar (ÎÖÑÏ£º)';
    const div=document.createElement('div'); div.className='pcard';
    div.innerHTML = `
      <div class="ptitle">${title}</div>
      <div class="box ${colorCls(p.stem)}">${p.stem||'?'}</div>
      <div class="box ${colorCls(p.branch)}" style="margin-top:8px">${p.branch||'?'}</div>
      ${god?`<div class="subline">${god}</div>`:''}
    `;
    root.appendChild(div);
  });
}
function renderLuck(luck, birthISO){
  const root=Q('#luck'); root.innerHTML='';
  const list=luck?.bigLuck||[]; if(!list.length) return;
  const a=age(birthISO);
  list.forEach(({startAge,stem,branch,tenGod})=>{
    const seg=document.createElement('div');
    const now= typeof a==='number' && a>=startAge && a<startAge+10;
    seg.className='lseg '+(now?'lnow':'');
    seg.innerHTML=`<div class="lh">Age ${startAge}‚Äì${startAge+9}</div>
      <div class="lgan">${stem||''}${branch||''}</div>
      ${tenGod?`<div class="small">${tenGod}</div>`:''}`;
    root.appendChild(seg);
  });
}
</script>

<!-- READING Î†åÎçîÎü¨Îäî Í∏∞Ï°¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (ÏÉùÎûµ) -->
<script>
/* ---------- READING (ÏöîÏïΩ) : Í∏∞Ï°¥ ÌîÑÎ°úÏ†ùÌä∏ Î°úÏßÅ Ïú†ÏßÄ ---------- */
function renderReading7(sections){ const root=Q('#reading'); root.innerHTML=''; /* Ïù¥ÎØ∏ Íµ¨ÌòÑÎêòÏñ¥ ÏûàÎäî Î≤ÑÏ†Ñ ÏÇ¨Ïö© Ï§ë */ }
</script>

<script>
/* ---------- Specific Fortunes (Í∞úÌé∏) ---------- */
/* 6Í∞ú Ïπ¥ÌÖåÍ≥†Î¶¨: ÏÑ±Í≤©¬∑Ïù∏ÏÑ± / ÏßÅÏóÖ¬∑Î™ÖÏòà / Ïû¨Î¨º¬∑Ïû¨Ïö¥ / Î∂ÄÎ∂Ä¬∑Ïó∞Ïï† / Í±¥Í∞ïÏö¥ / Ïö¥ÏÑ∏ ÌùêÎ¶Ñ */
const TOPICS = [
  {key:'personality', icon:'üß≠', name:'Personality & Traits', hint:'Strengths, blind spots, fit.'},
  {key:'career_status', icon:'üéØ', name:'Career, Reputation & Influence', hint:'Talents, roles, visibility.'},
  {key:'wealth', icon:'üí∞', name:'Wealth & Finance', hint:'Income, assets, timing.'},
  {key:'relationship', icon:'‚ù§Ô∏è', name:'Marriage & Relationship', hint:'Partner vibe, timing, friction.'},
  {key:'health', icon:'üåø', name:'Health & Longevity', hint:'Body signals, balance, care.'},
  {key:'timing', icon:'‚è±Ô∏è', name:'Life Cycle & Timing', hint:'This year & next decade.'},
];

function mountFortuneGrid(){
  const g=Q('#fgrid'); if(!g) return;
  g.innerHTML='';
  TOPICS.forEach(t=>{
    const card=document.createElement('div'); card.className='ftile'; card.dataset.key=t.key;
    card.innerHTML=`
      <div class="ftop">
        <div class="fleft">
          <div class="ficon">${t.icon}</div>
          <div>
            <div class="fname">${t.name}</div>
            <div class="fhint">${t.hint}</div>
          </div>
        </div>
        <button class="see">See insights</button>
      </div>
      <div class="fcontent"></div>
    `;
    g.appendChild(card);
  });
  g.querySelectorAll('.see').forEach(btn=>{
    btn.addEventListener('click',()=>expandTopic(btn.closest('.ftile')));
  });
}

/* fortune ÏΩòÌÖêÏ∏† Î†åÎçîÎßÅ: Ï†úÎ™©/Î∂ÄÏ†ú/Î≥∏Î¨∏ Îã®Ïùº ÏïÑÌã∞ÌÅ¥ */
function renderFortuneArticle(container, title, subtitle, bodyHtml){
  container.innerHTML = `
    <div class="block f-article">
      <h4>${title}</h4>
      ${subtitle?`<div class="sub">${subtitle}</div>`:''}
      ${bodyHtml}
      <div class="closewrap"><button class="closebtn">Close</button></div>
    </div>
  `;
  container.style.display='block';
  const cbtn = container.querySelector('.closebtn');
  const btn = container.closest('.ftile').querySelector('.see');
  if (cbtn) cbtn.addEventListener('click',()=>{container.style.display='none'; if(btn) btn.style.display='inline-block';});
}

/* API ÏãúÎèÑ (Í∏∞Ï°¥ ÏóîÎìúÌè¨Ïù∏Ìä∏ Ìò∏Ìôò) */
async function callFortuneAPI(frontKey){
  const ctx = window.__chartCtx || null;
  const tryList = [
    {m:'POST', url:'/api/fortune', body:{topic:frontKey, ctx}},
    {m:'POST', url:'/api/ask', body:{topic:frontKey, mode:'fortune', ctx}},
    {m:'GET', url:`/api/fortune?topic=${encodeURIComponent(frontKey)}`},
    {m:'GET', url:`/api/ask?topic=${encodeURIComponent(frontKey)}&mode=fortune`},
  ];
  for (const a of tryList){
    const opt = a.m==='POST'? {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(a.body||{})} : {};
    const r = await fetchJSON(a.url,opt);
    if (r.ok && (r.data?.output || r.data?.data)) return {ok:true, data:r.data.output || r.data.data};
  }
  return {ok:false};
}

/* ÏùëÎãµ ‚Üí Îã®Ïùº Î≥∏Î¨∏ÏúºÎ°ú Ï†ïÎ¶¨ */
function toSingleArticle(topicKey, apiOut){
  // 1) Í∞ÄÎä•Ìïú ÌïÑÎìúÎ•º ÏµúÎåÄÌïú ÏàòÏö©
  const text = (apiOut?.article || apiOut?.content || apiOut?.body || apiOut?.markdown || apiOut?.text || '').toString();
  if (text.trim()) return text;

  // 2) ÌùîÌïú Íµ¨Ï°∞Î•º Ìï©ÏπòÍ∏∞
  const parts = [];
  const push = v=>{ if (typeof v==='string' && v.trim()) parts.push(v.trim()); };
  if (apiOut?.overview) push(apiOut.overview);
  if (apiOut?.summary) push(apiOut.summary);
  if (apiOut?.tips) push(Array.isArray(apiOut.tips)? apiOut.tips.map(x=>`‚Ä¢ ${x}`).join('\n') : apiOut.tips);
  if (apiOut?.watch) push(Array.isArray(apiOut.watch)? apiOut.watch.map(x=>`‚Ä¢ ${x}`).join('\n') : apiOut.watch);
  if (Array.isArray(apiOut?.blocks)) apiOut.blocks.forEach(b=>push(b?.text||b?.body||b));
  if (Array.isArray(apiOut?.cards)) apiOut.cards.forEach(c=>push(c?.body||c?.text||c));
  return parts.join('\n\n');
}

/* Ï∞®Ìä∏ Í∏∞Î∞ò Ìï©ÏÑ±(Î∞±ÏóÖ) */
function synthesizeArticle(topicKey, ctx){
  const pillars=ctx?.pillars||{};
  const countElems=()=>{const m={wood:0,fire:0,earth:0,metal:0,water:0}; ['hour','day','month','year'].forEach(k=>{const p=pillars[k]; if(!p) return; const e1=STEM_ELEM[p.stem], e2=BRANCH_ELEM[p.branch]; if(e1)m[e1]++; if(e2)m[e2]++;}); return m;};
  const em=countElems(); const dom=Object.entries(em).sort((a,b)=>b[1]-a[1])[0]?.[0]||'mixed';
  const {bigLuck=[]}=ctx?.luck||{};
  const nowAge=age(ctx?.birthDateISO||'');
  const cur = bigLuck.find(s=> nowAge>=s.startAge && nowAge<s.startAge+10) || null;
  const decade = cur ? `Current decade ${cur.startAge}‚Äì${cur.startAge+9} ${cur.stem||''}${cur.branch||''}` : 'Current decade N/A';

  const baseOpen = `Based on your pillars and element balance, your dominant tone looks **${dom}**. ${decade}.`;

  switch(topicKey){
    case 'personality':
      return `${baseOpen}\n\n‚Ä¢ Core style: how you decide / recharge / relate.\n‚Ä¢ Strengths to lean into; blind spots to watch.\n‚Ä¢ Situations where your tone shines vs. drains.`;
    case 'career_status':
      return `${baseOpen}\n\n‚Ä¢ Roles that match your rhythm (builder vs. explorer vs. steward).\n‚Ä¢ Where influence/reputation grows fastest this decade.\n‚Ä¢ One visibility habit to add this month.`;
    case 'wealth':
      return `${baseOpen}\n\n‚Ä¢ Cashflow posture (stable vs. variable) by element mix.\n‚Ä¢ One saving rule and one investing rule that fits your energy.\n‚Ä¢ Red flags to avoid during Metal‚Äëleaning months.`;
    case 'relationship':
      return `${baseOpen}\n\n‚Ä¢ Your partner vibe and boundaries.\n‚Ä¢ Seasons better for dating/commitment.\n‚Ä¢ A weekly ritual to keep connection steady.`;
    case 'health':
      return `${baseOpen}\n\n‚Ä¢ Body systems that ask for support by element.\n‚Ä¢ Work/Rest rhythm that protects recovery.\n‚Ä¢ 2 small habits to anchor sleep & stress.`;
    case 'timing':
    default:
      return `${baseOpen}\n\n‚Ä¢ Quick lanes for the next 90 days.\n‚Ä¢ Good windows for launches vs. drafts.\n‚Ä¢ One thing to delay until quieter weeks.`;
  }
}

/* ÌôïÏû• ÎèôÏûë */
async function expandTopic(card){
  if (!card || card.dataset.loading === '1') return;
  card.dataset.loading = '1';
  const key=card.dataset.key;
  const btn=card.querySelector('.see');
  const content=card.querySelector('.fcontent');
  if (btn) { btn.disabled=true; btn.textContent='Loading‚Ä¶'; }

  try{
    // 1) API ÏãúÎèÑ
    const api = await callFortuneAPI(key);
    let article = '';
    if (api.ok){
      article = toSingleArticle(key, api.data);
    }
    // 2) Î∞±ÏóÖ Ìï©ÏÑ±
    if (!article || !article.trim()){
      article = synthesizeArticle(key, window.__chartCtx||{});
    }
    // 3) Í∞ÄÎèÖÏÑ± ÎßàÌÅ¨ÏóÖ
    const html = mdFortuneBlock(article);
    // 4) Ïπ¥Îìú Î†åÎçî
    const topicMeta = TOPICS.find(t=>t.key===key) || {name:'Insight', hint:''};
    renderFortuneArticle(content, topicMeta.name, topicMeta.hint, html);
    if (btn) btn.style.display='none';
  }catch(e){
    content.innerHTML = `
      <div class="block">
        <div class="btitle">Couldn‚Äôt open this insight</div>
        <div class="small">${escapeHtml(String(e))}</div>
        <div class="closewrap"><button class="closebtn">Close</button></div>
      </div>`;
    content.style.display='block';
    const cbtn = content.querySelector('.closebtn');
    if (cbtn) cbtn.addEventListener('click',()=>{content.style.display='none'; if(btn) btn.style.display='inline-block';});
  }finally{
    if (btn){ btn.disabled=false; btn.textContent='See insights'; }
    delete card.dataset.loading;
  }
}

if (document.querySelector('#fgrid')) { mountFortuneGrid(); }
</script>

<script>
/* ---------- Ask (Í∑∏ÎåÄÎ°ú) ---------- */
function addMsg(text,who='bot'){
  const p=document.createElement('div'); p.className='msg '+(who==='me'?'me':'bot'); p.innerHTML=escapeHtml(text).replace(/\n/g,'<br>');
  const box=Q('#chat'); box.appendChild(p); box.scrollTop=box.scrollHeight;
}
function summarizeChart(ctx){
  if(!ctx) return 'No chart context.';
  const p=ctx.pillars||{};
  const hour=`${p.hour?.stem||''}${p.hour?.branch||''}`.trim();
  const day =`${p.day?.stem||''}${p.day?.branch||''}`.trim();
  const month=`${p.month?.stem||''}${p.month?.branch||''}`.trim();
  const year=`${p.year?.stem||''}${p.year?.branch||''}`.trim();
  return `Pillars: Hour ${hour}, Day ${day}, Month ${month}, Year ${year}.`;
}
function buildAskPrompt(q, ctx){
  const summary=summarizeChart(ctx);
  return [
    'You are a Saju/Bazi guide. Tone: clear, warm, practical.',
    'Format: concise answer + 3 bullets + 1 timing hint if relevant.',
    'Chart context:', summary, '', 'Question:', q
  ].join('\n');
}
async function ask(q){
  addMsg(q,'me');
  try{
    const payload = { q: buildAskPrompt(q, window.__chartCtx||null), mode:'chat', ctx:window.__chartCtx||null };
    let r = await fetchJSON('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok || (!r.data?.ok && !r.data?.output)){
      r = await fetchJSON(`/api/ask?q=${encodeURIComponent(payload.q)}`);
    }
    if(!r.ok||(!r.data?.ok && !r.data?.output)){ addMsg("I couldn‚Äôt quite catch that. Could you rephrase your question? üôÇ"); return; }
    addMsg(r.data.output||"Here‚Äôs my take based on your chart.");
  }catch{ addMsg("‚ö†Ô∏è Network error ‚Äî please try again."); }
}
</script>

<script>
/* ---------- main flow (ÏöîÏïΩ) ---------- */
Q('#fill').addEventListener('click',()=>{
  Q('#yy').value='1989'; Q('#mm').value='10'; Q('#dd').value='20'; Q('#hh').value='06'; Q('#min').value='00';
  Q('#city').value='seoul';
});
Q('#askBtn').addEventListener('click',()=>{
  const v=Q('#ask').value.trim(); if(!v) return; Q('#ask').value=''; ask(v);
});

Q('#run').addEventListener('click', async ()=>{
  const yy=Q('#yy').value, mm=Q('#mm').value, ddv=Q('#dd').value, hh=Q('#hh').value, mi=Q('#min').value;
  const city=Q('#city').value.trim();
  if(!city){ setStatus('Please enter a birth city.', 'err'); return; }
  const birthDateISO=`${yyyy(yy)}-${mm}-${ddv}`;
  const birthTime=`${hh}:${mi}`;

  setStatus('Step 1/3: Resolving city ‚Üí timezone‚Ä¶');
  const geo=await fetchJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`);
  if(!geo.ok||!geo.data?.timezone){ setStatus('Failed on Step 1 (geo-timezone).','err'); return; }
  const {lat,lng}=geo.data.location; const tzId=geo.data.timezone;

  setStatus('Step 2/3: Calculating pillars‚Ä¶');
  const calc=await fetchJSON('/api/calc',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({birthDateISO,birthTime,lat,lng,tzId,timeAccuracy:'exact'})});
  if(!calc.ok||!calc.data?.data){ setStatus('Failed on Step 2 (calc).','err'); return; }
  const d=calc.data.data||{}; const {pillars,elements,tenGods,interactions,luck}=d;

  renderPillars(pillars,tenGods);
  renderLuck(luck,birthDateISO);

  window.__chartCtx = { pillars, elements, tenGods, luck, birthDateISO, tzId, lat, lng };

  setStatus('Step 3/3: Generating reading‚Ä¶');
  // (ÌîÑÎ°úÏ†ùÌä∏Ïùò Í∏∞Ï°¥ reading API Ìò∏Ï∂ú Î°úÏßÅ ÏÇ¨Ïö©)
  // Ïó¨Í∏∞ÏÑú renderReading7(...) Ìò∏Ï∂úÌïòÎèÑÎ°ù Ïó∞Í≤∞ÎêòÏñ¥ ÏûàÏùÑ Í≤É

  setStatus(`Done ‚Ä¢ tz: ${tzId} ‚Ä¢ lat:${lat.toFixed(4)}, lng:${lng.toFixed(4)}`,'ok');

  // ÏµúÏã† Ïª®ÌÖçÏä§Ìä∏ Í∏∞Ï§ÄÏúºÎ°ú fortune Î≤ÑÌäº Ïû¨Î∞îÏù∏Îî©
  mountFortuneGrid();

  dbgEl.textContent = 'geo-timezone\n'+JSON.stringify(geo.data,null,2)
    +'\n\ncalc\n'+JSON.stringify(calc.data,null,2);
});
/* boot */
mountFortuneGrid();
addMsg("Hi! Ask me anything about timing, relationships, career, or health. I‚Äôll use your current chart as context.",'bot');
</script>
</body>
</html>
