<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Saju‚ÄëEight ‚Ä¢ End‚Äëto‚ÄëEnd Playground</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1220;--panel:#121a2a;--muted:#8aa0c3;--txt:#ecf2ff;--accent:#66b3ff;--ok:#49d39a;--err:#ff7a7a;}
*{box-sizing:border-box} body{margin:0;background:linear-gradient(120deg,#0b1220,#0e2342);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,Arial}
.wrap{max-width:1060px;margin:28px auto 80px;padding:0 18px}
.h1{font-size:26px;font-weight:800;margin:6px 0 8px}
.sub{color:var(--muted);margin-bottom:18px}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);margin-top:12px}
.section-title{font-size:12px;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin:0 0 8px}
.row{display:flex;gap:10px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr 1fr 1fr 1fr;gap:10px}
select,button,input{background:#0b1426;color:var(--txt);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;outline:none}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px #66b3ff33}
button{background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:800;border:none;cursor:pointer}
button[disabled]{opacity:.6;cursor:not-allowed}
.help{color:var(--muted);font-size:13px;margin-top:6px}

/* Pillars */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pcard{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
.ptitle{font-size:12px;color:#a9bce3;margin-bottom:6px;text-align:center}
.box{height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:800;border:1px solid #0003}
.subline{font-size:11px;color:#cfe4ff;text-align:center;margin-top:6px}
.wood{background:#16a34a;color:#fff}.fire{background:#ef4444;color:#fff}
.earth{background:#f59e0b;color:#111}.metal{background:#e5e7eb;color:#111;border-color:#cbd5e1}
.water{background:#06b6d4;color:#fff}

/* Luck */
.luckbar{display:flex;gap:8px;overflow:auto}
.lseg{flex:1;min-width:84px;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:rgba(255,255,255,.05)}
.lh{font-size:12px;opacity:.85;margin-bottom:2px}
.lgan{font-weight:800}
.lnow{outline:2px solid var(--accent);box-shadow:0 0 0 4px #66b3ff33}

/* Reading (summary + details) */
.block{background:#14213d;border:1px solid #2c4168;border-radius:10px;padding:12px;margin-top:10px}
.btitle{color:#a9d6ff;font-weight:800;margin-bottom:6px}
.bul{padding-left:18px;margin:6px 0}
.call{margin-top:10px;padding:10px 12px;background:#49d39a18;border:1px solid #49d39a55;border-radius:10px}
.row-end{display:flex;justify-content:flex-end;margin-top:8px}
.ghost{background:#1b263f;border:1px solid #2c4168;color:#cfe2ff}

/* Fortunes 1√ó8 */
.fgrid{display:grid;grid-template-columns:1fr;gap:10px}
.ftile{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
.ftop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.fleft{display:flex;align-items:center;gap:12px}
.ficon{font-size:28px}
.fname{font-weight:800}
.fhint{font-size:12px;color:var(--muted)}
.fcontent{margin-top:10px;display:none}
.closewrap{display:flex;justify-content:flex-end;margin-top:12px}

/* Chat */
.chat{background:#0f1a30;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;height:360px;overflow:auto}
.msg{max-width:78%;padding:10px 12px;border-radius:10px;line-height:1.45;font-size:14px}
.me{align-self:flex-end;background:#3a86ff;color:#081326}
.bot{align-self:flex-start;background:#14213d;border:1px solid #2c4168}
.inputrow{display:flex;gap:8px;margin-top:8px}
.text{flex:1}
.small{font-size:12px;color:var(--muted)}
.err{color:var(--err)} .ok{color:var(--ok)}
.sx-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
.sx-kicker{font-size:12px;letter-spacing:.16em;text-transform:uppercase;opacity:.7;margin-bottom:6px}
.sx-pre{white-space:pre-wrap;opacity:.85;margin-top:6px;background:#0b1426;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:8px;max-height:220px;overflow:auto}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">Saju‚ÄëEight ‚Ä¢ End‚Äëto‚ÄëEnd Playground</div>
  <div class="sub">Enter birth info ‚Üí timezone ‚Üí pillars ‚Üí 6‚Äësection English reading (summary + details) ‚Üí specific fortunes ‚Üí ask follow‚Äëups.</div>

  <!-- Form -->
  <div class="card">
    <div class="grid2">
      <select id="yy"></select><select id="mm"></select><select id="dd"></select><select id="hh"></select><select id="min"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="city" class="text" placeholder="Seoul / New York / Tokyo"/>
      <button id="run">Calculate & Generate</button>
      <button id="fill" type="button">Fill Example</button>
    </div>
    <div id="status" class="help"></div>
  </div>

  <!-- Pillars -->
  <div class="card">
    <div class="section-title">Four Pillars</div>
    <div id="pillars" class="pillars"></div>
  </div>

  <!-- Luck -->
  <div class="card">
    <div class="section-title">Big Luck (10‚Äëyear cycles)</div>
    <div id="luck" class="luckbar"></div>
  </div>

  <!-- Reading -->
  <div class="card">
    <div class="section-title">Reading</div>
    <div id="reading"></div>
  </div>

  <!-- Specific Fortunes -->
  <div class="card">
    <div class="section-title">Explore Specific Fortunes</div>
    <div id="fgrid" class="fgrid"></div>
  </div>

  <!-- Ask -->
  <div class="card">
    <div class="section-title">Ask About Your Saju</div>
    <div id="chat" class="chat"></div>
    <div class="inputrow">
      <input id="ask" class="text" placeholder="Type your question‚Ä¶"/>
      <button id="askBtn">Ask</button>
    </div>
    <div class="small">I‚Äôll use your current chart as context.</div>
  </div>

  <!-- Debug -->
  <details class="card"><summary>Debug JSON (geo/calc/reading)</summary><pre id="dbg" style="white-space:pre-wrap"></pre></details>
</div>

<script>
/* ---------- tiny utils ---------- */
const Q=s=>document.querySelector(s), S=s=>document.querySelectorAll(s);
const statusEl=Q('#status'), dbgEl=Q('#dbg');
const STEM_ELEM={Áî≤:'wood',‰πô:'wood',‰∏ô:'fire',‰∏Å:'fire',Êàä:'earth',Â∑±:'earth',Â∫ö:'metal',Ëæõ:'metal',Â£¨:'water',Áô∏:'water'};
const BRANCH_ELEM={Â≠ê:'water',‰∏ë:'earth',ÂØÖ:'wood',ÂçØ:'wood',Ëæ∞:'earth',Â∑≥:'fire',Âçà:'fire',Êú™:'earth',Áî≥:'metal',ÈÖâ:'metal',Êàå:'earth',‰∫•:'water'};
const COLOR={wood:'wood',fire:'fire',earth:'earth',metal:'metal',water:'water'};
const hEsc=s=>(s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));
const pad2=n=>String(n).padStart(2,'0'), pad4=n=>String(n).padStart(4,'0');
function setStatus(msg,type=''){statusEl.textContent=msg;statusEl.className='help '+(type||'')}
async function fetchJSON(url,opt){try{const r=await fetch(url,opt);const t=await r.text();let d=null;try{d=JSON.parse(t)}catch{}return{ok:r.ok&&!!d,status:r.status,data:d,raw:t}}catch(e){return{ok:false,status:0,data:null,raw:String(e?.message||e)}}}
function age(iso){const b=new Date(iso+'T00:00:00');const n=new Date();let a=n.getFullYear()-b.getFullYear();const m=n.getMonth()-b.getMonth();if(m<0||(m===0&&n.getDate()<b.getDate()))a--;return a}

/* ---------- form ---------- */
(function initSelects(){
  const y=Q('#yy'),m=Q('#mm'),d=Q('#dd'),h=Q('#hh'),mi=Q('#min');
  for(let i=1940;i<=2025;i++){y.append(new Option(i,i))}
  for(let i=1;i<=12;i++){m.append(new Option(pad2(i),pad2(i)))}
  for(let i=1;i<=31;i++){d.append(new Option(pad2(i),pad2(i)))}
  for(let i=0;i<24;i++){h.append(new Option(pad2(i),pad2(i)))}
  for(let i=0;i<60;i+=5){mi.append(new Option(pad2(i),pad2(i)))}
  y.value='1989';m.value='10';d.value='20';h.value='06';mi.value='00';
})();
Q('#fill').addEventListener('click',()=>{Q('#yy').value='1989';Q('#mm').value='10';Q('#dd').value='20';Q('#hh').value='06';Q('#min').value='00';Q('#city').value='seoul'});

/* ---------- renderers ---------- */
function renderPillars(pillars,elements,tenGods,hiddenStems){
  const root=Q('#pillars');root.innerHTML='';
  ['hour','day','month','year'].forEach(k=>{
    const p=pillars?.[k]; if(!p) return;
    const s=COLOR[STEM_ELEM[p.stem]]||'wood', b=COLOR[BRANCH_ELEM[p.branch]]||'earth';
    const god=(tenGods?.byPillar?.[k]||tenGods?.[k]||'');
    const div=document.createElement('div');div.className='pcard';
    div.innerHTML=`
      <div class="ptitle">${k==='day'?'Day Pillar (ÏùºÏ£º) ¬∑ Day Master':k==='hour'?'Hour Pillar (ÏãúÏ£º)':k==='month'?'Month Pillar (ÏõîÏ£º)':'Year Pillar (ÎÖÑÏ£º)'}</div>
      <div class="box ${s}">${p.stem||'?'}</div>
      <div class="box ${b}" style="margin-top:8px">${p.branch||'?'}</div>
      ${god?`<div class="subline">${god}</div>`:''}
    `;
    root.appendChild(div);
  });
}
function renderLuck(luck,birthISO){
  const root=Q('#luck');root.innerHTML='';const list=luck?.bigLuck||[];if(!list.length) return;
  const a=age(birthISO);
  list.forEach(({startAge,stem,branch,tenGod})=>{
    const seg=document.createElement('div'), now= a>=startAge && a<startAge+10;
    seg.className='lseg '+(now?'lnow':'');
    seg.innerHTML=`<div class="lh">Age ${startAge}‚Äì${startAge+9}</div><div class="lgan">${stem||''}${branch||''}</div>${tenGod?`<div class="small">${tenGod}</div>`:''}`;
    root.appendChild(seg);
  });
}

/* Reading summary + details */
function renderReading6(sections){
  const root=Q('#reading');root.innerHTML='';
  const order=['core','balance','tengods','luck','wellness','summary'];
  const titleMap={core:'Your Unique Traits',balance:'Creating Balance in Life',tengods:'Understanding Your Ten Gods',luck:'Your Luck Cycle',wellness:'Wellness Suggestions',summary:'Summary of Insights'};
  order.forEach(k=>{
    const sec=sections?.[k]; if(!sec) return;
    const div=document.createElement('div');div.className='block';
    // summary line(Ïâ¨Ïö¥ Î¨∏Ïû•) + details Ïà®ÍπÄ
    const detailsId='det_'+k+'_'+Math.random().toString(36).slice(2);
    div.innerHTML=`
      <div class="btitle">${titleMap[k]||k}</div>
      <div>${hEsc(sec.summary||'')}</div>
      <div class="row-end"><button class="ghost" data-target="${detailsId}">See details</button></div>
      <div id="${detailsId}" style="display:none;margin-top:8px">
        ${sec.details?.text?`<div>${hEsc(sec.details.text)}</div>`:''}
        ${Array.isArray(sec.details?.bullets)?`<ul class="bul">${sec.details.bullets.map(x=>`<li>${hEsc(x)}</li>`).join('')}</ul>`:''}
        ${sec.details?.try?`<div class="call"><b>Try:</b> ${hEsc(sec.details.try)}</div>`:''}
      </div>
    `;
    root.appendChild(div);
  });
  // toggle
  S('.ghost').forEach(b=>b.onclick=()=>{const t=Q('#'+b.dataset.target);const open=t.style.display!=='none';t.style.display=open?'none':'block';b.textContent=open?'See details':'Hide details'});
}

/* ---------- fortunes ---------- */
const TOPICS=[
  {key:'wealth',icon:'üí∞',name:'Wealth & Money',hint:'Income, savings, timing.'},
  {key:'love',icon:'‚ù§Ô∏è',name:'Love & Relationships',hint:'Compatibility, timing.'},
  {key:'career',icon:'üß∞',name:'Career & Growth',hint:'Fit, leadership vs craft.'},
  {key:'health',icon:'üåø',name:'Health & Wellness',hint:'Imbalance ‚Üí care.'},
  {key:'family',icon:'üë∂',name:'Family & Children',hint:'Fertility & dynamics.'},
  {key:'travel',icon:'‚úàÔ∏è',name:'Travel / Relocation',hint:'Good periods, cautions.'},
  {key:'learning',icon:'üìò',name:'Learning & Skills',hint:'What to study.'},
  {key:'timing',icon:'‚è±Ô∏è',name:'Timing & Windows',hint:'Short‚Äëterm chances.'},
];
function mountFortuneGrid(){
  const g=Q('#fgrid');g.innerHTML='';
  TOPICS.forEach(t=>{
    const card=document.createElement('div');card.className='ftile';card.dataset.key=t.key;
    card.innerHTML=`
      <div class="ftop">
        <div class="fleft"><div class="ficon">${t.icon}</div>
          <div><div class="fname">${t.name}</div><div class="fhint">${t.hint}</div></div>
        </div>
        <button class="see">See insights</button>
      </div>
      <div class="fcontent"></div>
    `;
    g.appendChild(card);
  });
  S('.ftile .see').forEach(btn=>btn.onclick=()=>expandTopic(btn.closest('.ftile')));
}
async function expandTopic(card){
  const key=card.dataset.key, btn=card.querySelector('.see'), content=card.querySelector('.fcontent');
  btn.disabled=true; btn.textContent='Loading‚Ä¶';
  try{
    const r=await fetchJSON('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topic:key})});
    if(!r.ok||!r.data?.ok){ content.innerHTML=`<div class="sx-card"><div class="sx-kicker">${key}</div><div>Network / Server error</div><div class="sx-pre">${hEsc(r?.data?.error||r.raw||'')}</div></div>`; content.style.display='block'; return; }
    const o=r.data.output||{}, label=r.data.label||'Insights';
    content.innerHTML=`
      <div class="block"><div class="btitle">Overview ‚Äî ${hEsc(label)}</div>${hEsc(o.overview||'')}</div>
      ${o.phases?`<div class="block"><div class="btitle">Key Phases</div>${hEsc(o.phases)}</div>`:''}
      ${o.watch?`<div class="block"><div class="btitle">Watch Out</div>${hEsc(o.watch)}</div>`:''}
      ${o.tips?`<div class="block"><div class="btitle">Tips</div>${hEsc(o.tips)}</div>`:''}
      <div class="closewrap"><button class="ghost closebtn">Close</button></div>
    `;
    content.style.display='block'; btn.style.display='none';
    content.querySelector('.closebtn').onclick=()=>{content.style.display='none';btn.style.display='inline-block'}
  } finally { btn.disabled=false; btn.textContent='See insights'; }
}

/* ---------- chat ---------- */
function addMsg(text,who='bot'){const p=document.createElement('div');p.className='msg '+(who==='me'?'me':'bot');p.textContent=text;Q('#chat').appendChild(p);const c=Q('#chat');c.scrollTop=c.scrollHeight}
async function ask(q){
  addMsg(q,'me');
  try{
    const r=await fetchJSON('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({q})});
    if(!r.ok||!r.data?.ok){ addMsg("I didn‚Äôt quite catch that. Could you rephrase it in a simple sentence? üôÇ",'bot'); return; }
    addMsg(r.data.output,'bot');
  }catch{ addMsg("‚ö†Ô∏è Network error ‚Äî please try again.",'bot'); }
}
Q('#askBtn').onclick=()=>{const v=Q('#ask').value.trim();if(!v)return;Q('#ask').value='';ask(v)}

/* ---------- main flow ---------- */
Q('#run').onclick=async()=>{
  const city=Q('#city').value.trim(); if(!city){setStatus('Please enter a birth city.','err');return}
  const birthDateISO=`${pad4(Q('#yy').value)}-${Q('#mm').value}-${Q('#dd').value}`, birthTime=`${Q('#hh').value}:${Q('#min').value}`;

  setStatus('Step 1/3: Resolving city ‚Üí timezone‚Ä¶');
  const geo=await fetchJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`); if(!geo.ok||!geo.data?.timezone){setStatus('Failed on Step 1 (geo-timezone).','err');return}
  const {lat,lng}=geo.data.location, tzId=geo.data.timezone;

  setStatus('Step 2/3: Calculating pillars‚Ä¶');
  const calc=await fetchJSON('/api/calc',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({birthDateISO,birthTime,lat,lng,tzId,timeAccuracy:'exact'})});
  if(!calc.ok||!calc.data?.data){setStatus('Failed on Step 2 (calc).','err');return}
  const d=calc.data.data||{}; const {pillars,elements,tenGods,hiddenStems,interactions,luck}=d;
  renderPillars(pillars,elements,tenGods,hiddenStems); renderLuck(luck,birthDateISO);

  setStatus('Step 3/3: Generating 6‚Äësection reading‚Ä¶');
  const read=await fetchJSON('/api/reading-generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pillars,elements,tenGods,interactions,locale:'en-US'})});
  if(!read.ok||!read.data?.ok){ const r=read; Q('#reading').innerHTML=`<div class="sx-card"><div class="sx-kicker">READING</div><div>Network / Server error</div><div class="sx-pre">${hEsc(r?.data?.error||r.raw||'')}</div><div style="opacity:.75;margin-top:6px">Check your server logs or API key.</div></div>`; setStatus('Failed on Step 3 (reading).','err'); return; }
  renderReading6(read.data.output?.sections||{});

  setStatus(`Done ‚Ä¢ tz:${tzId} ‚Ä¢ lat:${lat.toFixed(4)}, lng:${lng.toFixed(4)}`,'ok'); mountFortuneGrid();
  dbgEl.textContent='geo-timezone\n'+JSON.stringify(geo.data,null,2)+'\n\ncalc\n'+JSON.stringify(calc.data,null,2)+'\n\nreading\n'+JSON.stringify(read.data,null,2);
};

/* boot */
mountFortuneGrid();
addMsg("Hi! Ask me anything about timing, relationships, career, or health. I‚Äôll use your current chart as context.",'bot');
</script>
</body>
</html>
