<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Saju‑Eight • End‑to‑End Playground</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1220;--panel:#121a2a;--muted:#8aa0c3;--txt:#ecf2ff;--accent:#66b3ff;--ok:#49d39a;--err:#ff7a7a}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(120deg,#0b1220,#0e2342);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,Arial}
.wrap{max-width:1060px;margin:28px auto 80px;padding:0 18px}
.h1{font-size:26px;font-weight:800;margin:6px 0 8px}
.sub{color:var(--muted);margin-bottom:18px}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);margin-top:12px}
.section-title{font-size:12px;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin:0 0 8px}
.row{display:flex;gap:10px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
select,button,input{background:#0b1426;color:var(--txt);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;outline:none}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px #66b3ff33}
button{background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:800;border:none;cursor:pointer}
button[disabled]{opacity:.6;cursor:not-allowed}
.help{color:var(--muted);font-size:13px;margin-top:6px}
/* pillars */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pcard{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
.ptitle{font-size:12px;color:#a9bce3;margin-bottom:6px;text-align:center}
.box{height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:800;border:1px solid #0003}
.subline{font-size:11px;color:#cfe4ff;text-align:center;margin-top:6px}
.wood{background:#16a34a;color:#fff}.fire{background:#ef4444;color:#fff}
.earth{background:#f59e0b;color:#111}.metal{background:#e5e7eb;color:#111;border-color:#cbd5e1}
.water{background:#06b6d4;color:#fff}
/* big luck */
.luckbar{display:flex;gap:8px}
.lseg{flex:1;min-width:84px;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:rgba(255,255,255,.05)}
.lh{font-size:12px;opacity:.85;margin-bottom:2px}
.lgan{font-weight:800}
.lnow{outline:2px solid var(--accent);box-shadow:0 0 0 4px #66b3ff33}
/* reading */
.block{background:#14213d;border:1px solid #2c4168;border-radius:10px;padding:12px;margin-top:10px}
.btitle{color:#a9d6ff;font-weight:800;margin-bottom:6px}
.bsubtitle{color:#9dc6ff;font-size:12px;margin:-2px 0 8px;opacity:.9}
.bul{padding-left:18px;margin:6px 0}
.call{margin-top:10px;padding:10px 12px;background:#49d39a18;border:1px solid #49d39a55;border-radius:10px}
/* fortunes */
.fgrid{display:grid;grid-template-columns:1fr;gap:10px}
.ftile{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
.ftop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.fleft{display:flex;align-items:center;gap:10px}
.ficon{font-size:24px}
.fname{font-weight:700}
.fhint{font-size:12px;color:var(--muted)}
.fcontent{margin-top:10px;display:none}
.closewrap{display:flex;justify-content:flex-end}
.closebtn{margin-top:16px;background:#22314c;border:1px solid #2c4168;color:#cfe2ff;padding:8px 10px;border-radius:8px}
/* chat */
.chat{background:#0f1a30;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;height:220px;overflow:auto}
.msg{max-width:78%;padding:10px 12px;border-radius:10px;line-height:1.45;font-size:14px}
.me{align-self:flex-end;background:#3a86ff;color:#081326}
.bot{align-self:flex-start;background:#14213d;border:1px solid #2c4168}
.inputrow{display:flex;gap:8px;margin-top:8px}
.text{flex:1}
.small{font-size:12px;color:var(--muted)}
.err{color:var(--err)}.ok{color:var(--ok)}
@media(min-width:760px){.grid2{grid-template-columns:repeat(5,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">Saju‑Eight • End‑to‑End Playground</div>
  <div class="sub">Enter birth info → timezone → pillars → 7‑section reading → explore specific fortunes → ask follow‑ups (with chart context).</div>

  <div class="card">
    <div class="grid2">
      <select id="yy"></select>
      <select id="mm"></select>
      <select id="dd"></select>
      <select id="hh"></select>
      <select id="min"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="city" class="text" placeholder="Seoul / New York / Tokyo"/>
      <button id="run">Calculate & Generate</button>
      <button id="fill" type="button">Fill Example</button>
    </div>
    <div id="status" class="help"></div>
  </div>

  <div class="card">
    <div class="section-title">Four Pillars</div>
    <div id="pillars" class="pillars"></div>
  </div>

  <div class="card">
    <div class="section-title">Big Luck (10‑year cycles)</div>
    <div id="luck" class="luckbar"></div>
  </div>

  <div class="card">
    <div class="section-title">Reading</div>
    <div id="reading"></div>
  </div>

  <div class="card">
    <div class="section-title">Explore Specific Fortunes</div>
    <div id="fgrid" class="fgrid"></div>
  </div>

  <div class="card">
    <div class="section-title">Ask About Your Saju</div>
    <div id="chat" class="chat"></div>
    <div class="inputrow">
      <input id="ask" class="text" placeholder="Type your question…"/>
      <button id="askBtn">Ask</button>
    </div>
    <div class="small">I’ll use your current chart as context.</div>
  </div>

  <details class="card">
    <summary>Debug JSON (geo/calc/reading)</summary>
    <pre id="dbg" style="white-space:pre-wrap"></pre>
  </details>
</div>

<script>
/* ---------- util ---------- */
const Q = (s)=>document.querySelector(s);
const S = (s)=>document.querySelectorAll(s);
const statusEl = Q('#status'), dbgEl=Q('#dbg');
function setStatus(msg,type=''){ statusEl.textContent=msg; statusEl.className='help '+(type||''); }

async function fetchJSON(url,opt){
  try{
    const r=await fetch(url,opt); const txt=await r.text();
    let data=null; try{ data=JSON.parse(txt) }catch{}
    return { ok:r.ok && !!data, status:r.status, data, raw:txt };
  }catch(e){ return { ok:false, status:0, data:null, raw:String(e&&e.message||e) }; }
}

function yyyy(n){return String(n).padStart(4,'0')}
function dd(n){return String(n).padStart(2,'0')}
function age(b){const d=new Date(b+"T00:00:00");const n=new Date();let a=n.getFullYear()-d.getFullYear();const m=n.getMonth()-d.getMonth(); if(m<0||(m===0&&n.getDate()<d.getDate())) a--; return a;}

(function initSelects(){
  const y=Q('#yy'), m=Q('#mm'), d=Q('#dd'), h=Q('#hh'), mi=Q('#min');
  for(let i=1940;i<=2025;i++) y.appendChild(new Option(i,i));
  for(let i=1;i<=12;i++) m.appendChild(new Option(dd(i),dd(i)));
  for(let i=1;i<=31;i++) d.appendChild(new Option(dd(i),dd(i)));
  for(let i=0;i<24;i++) h.appendChild(new Option(dd(i),dd(i)));
  for(let i=0;i<60;i+=5) mi.appendChild(new Option(dd(i),dd(i)));
  y.value='1989'; m.value='10'; d.value='20'; h.value='06'; mi.value='00';
})();
</script>

<script>
/* ---------- safe markdown ---------- */
function asString(x){
  if (x==null) return '';
  if (typeof x==='string') return x;
  if (typeof x==='number' || typeof x==='boolean') return String(x);
  if (Array.isArray(x)) return x.map(asString).join('\n');
  const cand = x.text||x.summary||x.body||x.html||x.overview||'';
  return typeof cand==='string' ? cand : '';
}
function md(s=''){
  const raw = asString(s);
  if(!raw) return '';
  let t = raw.replace(/\r\n/g,'\n').trim();
  t = t.replace(/^### +(.+)$/gm,'<div class="btitle">$1</div>')
       .replace(/^## +(.+)$/gm,'<div class="btitle">$1</div>')
       .replace(/^# +(.+)$/gm,'<div class="btitle">$1</div>');
  t = t.split(/\n\n+/).map(block=>{
    const b = block.trim();
    if (/^(\-|\u2022) /.test(b)) {
      return '<ul class="bul">' + b.split('\n')
        .map(l=>l.replace(/^(\-|\u2022) +/, ''))
        .map(x=>`<li>${x}</li>`).join('') + '</ul>';
    }
    return `<p>${b}</p>`;
  }).join('');
  return t.replace(/\*\*(.+?)\*\*/g,'<b>$1</b>');
}
</script>

<script>
/* ---------- pillars & luck ---------- */
const STEM_ELEM = {甲:"wood",乙:"wood",丙:"fire",丁:"fire",戊:"earth",己:"earth",庚:"metal",辛:"metal",壬:"water",癸:"water"};
const BRANCH_ELEM={子:"water",丑:"earth",寅:"wood",卯:"wood",辰:"earth",巳:"fire",午:"fire",未:"earth",申:"metal",酉:"metal",戌:"earth",亥:"water"};
const colorCls = ch => (STEM_ELEM[ch]||BRANCH_ELEM[ch]||'wood');

function renderPillars(pillars, tenGods){
  const root=Q('#pillars'); root.innerHTML='';
  (['hour','day','month','year']).forEach(k=>{
    const p=pillars?.[k]; if(!p) return;
    const god = (tenGods?.byPillar?.[k] || tenGods?.[k] || '');
    const title = k==='day'?'Day Pillar (일주) · Day Master'
                : k==='hour'?'Hour Pillar (시주)'
                : k==='month'?'Month Pillar (월주)'
                : 'Year Pillar (년주)';
    const div=document.createElement('div'); div.className='pcard';
    div.innerHTML = `
      <div class="ptitle">${title}</div>
      <div class="box ${colorCls(p.stem)}">${p.stem||'?'}</div>
      <div class="box ${colorCls(p.branch)}" style="margin-top:8px">${p.branch||'?'}</div>
      ${god?`<div class="subline">${god}</div>`:''}
    `;
    root.appendChild(div);
  });
}
function renderLuck(luck, birthISO){
  const root=Q('#luck'); root.innerHTML='';
  const list=luck?.bigLuck||[]; if(!list.length) return;
  const a=age(birthISO);
  list.forEach(({startAge,stem,branch,tenGod})=>{
    const seg=document.createElement('div');
    const now= typeof a==='number' && a>=startAge && a<startAge+10;
    seg.className='lseg '+(now?'lnow':'');
    seg.innerHTML=`<div class="lh">Age ${startAge}–${startAge+9}</div>
      <div class="lgan">${stem||''}${branch||''}</div>
      ${tenGod?`<div class="small">${tenGod}</div>`:''}`;
    root.appendChild(seg);
  });
}
</script>

<script>
/* ---------- 7-section reading renderer ---------- */
const READING_META = [
  ['pillars','Your Four Pillars Overview','A quick glance at the overall chart structure.'],
  ['day_master','Day Master Traits','The element that represents “you”.'],
  ['five_elements','Element Balance','Where your energy leans — and what to watch.'],
  ['structure','Base Pattern (Structure)','Career vs. wealth vs. learning—your natural emphasis.'],
  ['yongshin','Helpful Focus (Yongshin)','Pick one supportive theme and make it a weekly non‑negotiable.'],
  ['life_flow','Decade Cycle','Big tailwinds & timing—not a rigid fate.'],
  ['summary','One‑Screen Summary','Strengths, watch‑outs, and a tiny habit to start this week.'],
];
function renderReading7(sections){
  const root=Q('#reading'); root.innerHTML='';
  READING_META.forEach(([key,title,subtitle])=>{
    const text = sections?.[key] || '';
    const div=document.createElement('div'); div.className='block';
    div.innerHTML = `
      <div class="btitle">${title}</div>
      <div class="bsubtitle">${subtitle}</div>
      <div>${md(text)||'<span class="small" style="opacity:.7">No content.</span>'}</div>
    `;
    root.appendChild(div);
  });
}
</script>

<script>
/* ---------- Specific Fortunes (생략: 기존과 동일) ---------- */
// ... (네가 쓰던 fortunes 코드 그대로 유지)
</script>

<script>
/* ---------- Ask (same as before) ---------- */
// ... (네가 쓰던 ask 코드 그대로 유지)
</script>

<script>
/* ---------- Step run (OpenAI 강제) ---------- */

// NEW: reading 응답 추출
function pickReadingOutput(respData){
  if (!respData) return null;
  return respData.output || respData.sections || null;
}

// NEW: OpenAI 강제 호출
async function fetchReadingAI(payload){
  // POST + query ?force=ai, body.useAI=true
  const r = await fetchJSON('/api/reading-generate?force=ai', {
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ ...payload, useAI:true, mode:'structured' })
  });
  return r;
}

Q('#fill').addEventListener('click',()=>{
  Q('#yy').value='1989'; Q('#mm').value='10'; Q('#dd').value='20'; Q('#hh').value='06'; Q('#min').value='00';
  Q('#city').value='seoul';
});

Q('#run').addEventListener('click', async ()=>{
  const yy=Q('#yy').value, mm=Q('#mm').value, ddv=Q('#dd').value, hh=Q('#hh').value, mi=Q('#min').value;
  const city=Q('#city').value.trim();
  if(!city){ setStatus('Please enter a birth city.', 'err'); return; }
  const birthDateISO=`${yyyy(yy)}-${mm}-${ddv}`;
  const birthTime=`${hh}:${mi}`;

  setStatus('Step 1/3: Resolving city → timezone…');
  const geo=await fetchJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`);
  if(!geo.ok||!geo.data?.timezone){ setStatus('Failed on Step 1 (geo-timezone).','err'); return; }
  const {lat,lng}=geo.data.location; const tzId=geo.data.timezone;

  setStatus('Step 2/3: Calculating pillars…');
  const calc=await fetchJSON('/api/calc',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({birthDateISO,birthTime,lat,lng,tzId,timeAccuracy:'exact'})});
  if(!calc.ok||!calc.data?.data){ setStatus('Failed on Step 2 (calc).','err'); return; }
  const d=calc.data.data||{}; const {pillars,elements,tenGods,interactions,luck}=d;

  renderPillars(pillars,tenGods);
  renderLuck(luck,birthDateISO);

  window.__chartCtx = { pillars, elements, tenGods, luck, birthDateISO, tzId, lat, lng };

  setStatus('Step 3/3: Generating reading (OpenAI)…');
  const r = await fetchReadingAI({pillars,elements,tenGods,interactions,luck,birthDateISO});
  if(!r.ok){
    setStatus('Failed on Step 3 (reading).','err');
    Q('#reading').innerHTML = `<div class="block">
      <div class="btitle">Reading error</div>
      <div class="small">OpenAI generation failed. Check server logs or API key.</div>
      <pre class="small" style="white-space:pre-wrap;background:#0b1426;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:8px;margin-top:8px;">${r.raw||''}</pre>
    </div>`;
    dbgEl.textContent = 'geo-timezone\n'+JSON.stringify(geo.data,null,2)
      +'\n\ncalc\n'+JSON.stringify(calc.data,null,2)
      +'\n\nreading (error)\n'+(r.raw||'');
    return;
  }

  const out = pickReadingOutput(r.data);
  if (!out){
    setStatus('Failed on Step 3 (reading payload).','err');
    Q('#reading').innerHTML = `<div class="block"><div class="btitle">Reading error</div><div class="small">No structured output.</div></div>`;
    return;
  }

  renderReading7(out);
  setStatus(`Done • tz: ${tzId} • lat:${lat.toFixed(4)}, lng:${lng.toFixed(4)}`,'ok');

  dbgEl.textContent = 'geo-timezone\n'+JSON.stringify(geo.data,null,2)
    +'\n\ncalc\n'+JSON.stringify(calc.data,null,2)
    +'\n\nreading\n'+JSON.stringify(r.data,null,2);
});
/* boot */
</script>
</body>
</html>
