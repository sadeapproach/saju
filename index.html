<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Saju-Eight ‚Ä¢ End-to-End Playground (Extended + Chat)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap">

  <style>
    :root{--bg:#0b1220;--panel:#121a2a;--muted:#6b7a90;--txt:#e9f0ff;--accent:#66b3ff;--ok:#49d39a;--err:#ff7a7a}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:linear-gradient(120deg,#0b1220,#0e2342);color:var(--txt)}
    .wrap{max-width:1040px;margin:42px auto;padding:0 18px}
    .title{font-size:26px;font-weight:800;margin-bottom:8px}
    .sub{color:var(--muted);font-size:13px;margin-bottom:18px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35)}
    .grid{display:grid;gap:10px}
    .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
    label{display:block;color:var(--muted);font-size:12px;margin-bottom:6px}
    select,input{width:100%;height:42px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1426;color:var(--txt);padding:0 12px;outline:none}
    select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(102,179,255,.2)}
    .row{display:flex;gap:10px}
    .row>*{flex:1}
    button{height:42px;border:none;border-radius:12px;background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:800;cursor:pointer}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .kicker{font-size:11px;letter-spacing:.16em;color:var(--muted);text-transform:uppercase;margin-bottom:8px}
    .headline{font-size:18px;font-weight:800;margin:0 0 8px}
    details{margin-top:10px}
    pre{background:#081123;border:1px solid rgba(255,255,255,.08);padding:12px;border-radius:12px;overflow:auto}

    /* Pillars */
    .pillars{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
    .pillar{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:16px;padding:12px}
    .pillar h5{margin:0 0 6px;font-size:12px;color:#9fb3d6;text-align:center}
    .tag{font-size:11px;color:#7dd3fc;text-align:center;margin-bottom:6px}
    .box{height:78px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:42px;font-weight:800;border:1px solid #0003}
    .wood{background:#16a34a;color:#fff}.fire{background:#ef4444;color:#fff}
    .earth{background:#f59e0b;color:#111}.metal{background:#e5e7eb;color:#111;border-color:#cbd5e1}
    .water{background:#06b6d4;color:#fff}
    .gauge{display:flex;height:10px;overflow:hidden;border-radius:10px;border:1px solid #293042;margin-top:12px}
    .gauge>div{height:100%}

    /* Big Luck */
    .luck{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
    .luck-seg{flex:1;min-width:140px;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px 10px;background:rgba(255,255,255,.05)}
    .luck-now{outline:2px solid #66b3ff;box-shadow:0 0 0 4px rgba(102,179,255,.2)}
    .seg-t{font-size:12px;color:#bcd0f2}
    .seg-g{font-size:15px;font-weight:800;margin-top:2px}
    .seg-s{font-size:11px;color:#9fb3d6;margin-top:2px}

    /* Reading sections */
    .section{margin-top:12px}
    .callout{margin-top:10px;padding:10px 12px;background:rgba(73,211,154,.09);border:1px solid rgba(73,211,154,.25);border-radius:12px}

    /* Topic grid */
    .topics{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media(min-width:860px){.topics{grid-template-columns:repeat(4,1fr)}}
    .topic{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:12px;background:rgba(255,255,255,.04)}
    .topic h4{margin:0 0 4px;font-size:14px}
    .topic p{margin:0 0 8px;color:#9fb3d6;font-size:12px}

    /* Chat (iMessage-like) */
    .chat-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:12px;margin-top:16px}
    .chat-log{height:280px;overflow:auto;display:flex;flex-direction:column;gap:10px;padding:8px;background:rgba(0,0,0,.25);border-radius:12px;border:1px solid rgba(255,255,255,.06)}
    .chat-row{display:flex}
    .chat-bubble{max-width:75%;padding:10px 12px;border-radius:16px;font-size:14px;line-height:1.45}
    .chat-user{justify-content:flex-end}
    .chat-user .chat-bubble{background:#4da3ff;color:#08111f;border-bottom-right-radius:6px}
    .chat-ai .chat-bubble{background:#1b2336;border:1px solid rgba(255,255,255,.08);color:#e7efff;border-bottom-left-radius:6px}
    .chat-input{display:flex;gap:8px;margin-top:10px}
    .chat-input input{flex:1;height:40px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1426;color:#e9f0ff;padding:0 12px;outline:none}
    .chat-input button{min-width:88px;border:none;border-radius:12px;background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:700;cursor:pointer}
  </style>
</head>
<body>
<div class="wrap">
  <div class="title">Saju-Eight ‚Ä¢ End-to-End Playground (Extended)</div>
  <div class="sub">Enter birth ‚Üí timezone ‚Üí pillars ‚Üí 6-section English reading. Explore topic cards, then ask follow-ups in chat.</div>

  <!-- FORM -->
  <div class="card">
    <div class="grid grid-4">
      <div><label>Birth year</label><select id="year"></select></div>
      <div><label>Birth month</label><select id="month"></select></div>
      <div><label>Birth day</label><select id="day"></select></div>
      <div><label>Hour</label><select id="hour"></select></div>
    </div>
    <div class="grid grid-4" style="margin-top:10px">
      <div><label>Minute</label><select id="minute"></select></div>
      <div><label>Birth city (in English)</label><input id="city" placeholder="Seoul / New York / Tokyo"/></div>
      <div class="row" style="align-items:end"><button id="calcBtn">Calculate & Generate</button></div>
      <div class="row" style="align-items:end"><button id="fillBtn" type="button">Fill Example</button></div>
    </div>
    <div id="status" class="muted" style="margin-top:8px"></div>
    <details style="margin-top:6px"><summary class="muted">What happens under the hood?</summary>
      <ul class="muted">
        <li>Step 1: <code>/api/geo-timezone</code> ‚Üí geocode + tzId</li>
        <li>Step 2: <code>/api/calc</code> ‚Üí pillars / elements / ten gods / luck</li>
        <li>Step 3: <code>/api/reading-generate</code> ‚Üí 6 English sections (or synthesized if missing)</li>
      </ul>
    </details>
  </div>

  <!-- FOUR PILLARS -->
  <div id="pillarsCard" class="card" style="margin-top:14px">
    <div class="kicker">FOUR PILLARS</div>
    <div id="pillarsRoot" class="pillars"></div>
    <div id="gaugeRoot" class="gauge" style="margin-top:12px"></div>
  </div>

  <!-- BIG LUCK -->
  <div id="luckCard" class="card" style="margin-top:12px">
    <div class="kicker">BIG LUCK (10-year cycles)</div>
    <div id="luckRoot" class="luck"></div>
  </div>

  <!-- READING (summary + 6 sections) -->
  <div id="readingCard" class="card" style="margin-top:12px">
    <div class="kicker">READING</div>
    <h3 class="headline" id="readTitle">Your Saju Reading</h3>
    <ul id="readBullets"></ul>
    <div class="callout" id="readTry" style="display:none"></div>
  </div>

  <div id="sections"></div>

  <!-- TOPIC GRID -->
  <div class="card" style="margin-top:12px">
    <div class="kicker">EXPLORE SPECIFIC FORTUNES</div>
    <div class="topics">
      <div class="topic"><h4>üí∞ Wealth & Money</h4><p>Income, savings, timing.</p><button id="tWealth">See insights</button></div>
      <div class="topic"><h4>‚ù§Ô∏è Love & Relationships</h4><p>Compatibility, meeting timing.</p><button id="tLove">See insights</button></div>
      <div class="topic"><h4>üß± Career & Growth</h4><p>Fit, leadership vs craft, pivots.</p><button id="tCareer">See insights</button></div>
      <div class="topic"><h4>üåø Health & Wellness</h4><p>Imbalance ‚Üí care routines.</p><button id="tHealth">See insights</button></div>
      <div class="topic"><h4>üë∂ Family & Children</h4><p>Fertility & family dynamics.</p><button id="tFamily">See insights</button></div>
      <div class="topic"><h4>‚úàÔ∏è Travel / Relocation</h4><p>Good periods, cautions.</p><button id="tTravel">See insights</button></div>
      <div class="topic"><h4>üìö Learning & Skills</h4><p>What to study, deepen talent.</p><button id="tLearn">See insights</button></div>
      <div class="topic"><h4>‚è±Ô∏è Timing & Windows</h4><p>Short-term chances.</p><button id="tTiming">See insights</button></div>
    </div>
  </div>

  <!-- CHAT Q&A -->
  <div class="chat-card" id="chatCard">
    <div class="kicker">ASK ABOUT YOUR SAJU</div>
    <div id="chatLog" class="chat-log">
      <div class="chat-row chat-ai">
        <div class="chat-bubble">Ask me anything about your Saju ‚Äî timing, relationships, career, or health. I‚Äôll use your current chart as context.</div>
      </div>
    </div>
    <div class="chat-input">
      <input id="chatInput" placeholder="e.g., When is a good time to change jobs?"/>
      <button id="chatSend">Ask</button>
    </div>
    <div id="chatError" class="muted" style="margin-top:6px"></div>
  </div>

  <details class="card" style="margin-top:12px">
    <summary>Debug JSON (geo/calc/reading)</summary>
    <pre id="dbgGeo"></pre>
    <pre id="dbgCalc"></pre>
    <pre id="dbgRead"></pre>
  </details>
</div>

<script>
/* ---------- helpers ---------- */
const el = q => document.querySelector(q);
const setStatus = (msg, type='') => { const s=el('#status'); s.textContent=msg; s.className='muted '+type; };
async function fetchJSON(url,opts={}){const r=await fetch(url,opts);const t=await r.text();try{return{ok:r.ok,status:r.status,data:JSON.parse(t),raw:t}}catch{return{ok:r.ok,status:r.status,data:null,raw:t}}}
const STEM_ELEM={Áî≤:"wood",‰πô:"wood",‰∏ô:"fire",‰∏Å:"fire",Êàä:"earth",Â∑±:"earth",Â∫ö:"metal",Ëæõ:"metal",Â£¨:"water",Áô∏:"water"};
const BRANCH_ELEM={Â≠ê:"water",‰∏ë:"earth",ÂØÖ:"wood",ÂçØ:"wood",Ëæ∞:"earth",Â∑≥:"fire",Âçà:"fire",Êú™:"earth",Áî≥:"metal",ÈÖâ:"metal",Êàå:"earth",‰∫•:"water"};
const COLOR={wood:"wood",fire:"fire",earth:"earth",metal:"metal",water:"water"};
const TITLES={hour:"Hour Pillar (ÏãúÏ£º)",day:"Day Pillar (ÏùºÏ£º)",month:"Month Pillar (ÏõîÏ£º)",year:"Year Pillar (ÎÖÑÏ£º)"};
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[c]))}

/* ---------- selects ---------- */
(function initSelects(){
  const y=el('#year'), m=el('#month'), d=el('#day'), h=el('#hour'), n=el('#minute');
  const now=new Date().getFullYear();
  for(let Y=1930;Y<=now;Y++){const o=document.createElement('option');o.value=Y;o.textContent=Y;y.appendChild(o)}
  for(let i=1;i<=12;i++){const v=String(i).padStart(2,'0');const o=document.createElement('option');o.value=v;o.textContent=v;m.appendChild(o)}
  for(let i=1;i<=31;i++){const v=String(i).padStart(2,'0');const o=document.createElement('option');o.value=v;o.textContent=v;d.appendChild(o)}
  for(let i=0;i<24;i++){const v=String(i).padStart(2,'0');const o=document.createElement('option');o.value=v;o.textContent=v;h.appendChild(o)}
  for(let i of [0,5,10,15,20,25,30,35,40,45,50,55]){const v=String(i).padStart(2,'0');const o=document.createElement('option');o.value=v;o.textContent=v;n.appendChild(o)}
  // default
  const def=new Date(); y.value=def.getFullYear(); m.value=String(def.getMonth()+1).padStart(2,'0'); d.value=String(def.getDate()).padStart(2,'0'); h.value="06"; n.value="00";
})();

/* ---------- UI renderers ---------- */
function renderPillars(pillars,elements){
  const root=el('#pillarsRoot'); root.innerHTML='';
  ["hour","day","month","year"].forEach(k=>{
    const p=pillars?.[k]; if(!p) return;
    const stemClass=COLOR[STEM_ELEM[p.stem]]||"wood";
    const brClass=COLOR[BRANCH_ELEM[p.branch]]||"earth";
    const card=document.createElement('div'); card.className='pillar';
    card.innerHTML=`
      <h5>${TITLES[k]}</h5>
      ${k==="day"?'<div class="tag">Day Master (Self) / ÏùºÍ∞Ñ(ÎÇò)</div>':''}
      <div class="box ${stemClass}">${p.stem}</div>
      <div class="box ${brClass}" style="margin-top:8px">${p.branch}</div>`;
    root.appendChild(card);
  });
  const g=el('#gaugeRoot');
  if(!elements){g.innerHTML='';return;}
  const bars=["wood","fire","earth","metal","water"].map(e=>{
    const pct=Math.max(2,Math.round((elements[e]||0)*100));
    return `<div class="${COLOR[e]}" style="width:${pct}%"></div>`;
  }).join('');
  g.innerHTML=bars;
}

function renderLuck(luck,birthISO){
  const age=calcAge(birthISO); const root=el('#luckRoot'); root.innerHTML='';
  const list=Array.isArray(luck?.bigLuck)?luck.bigLuck:[];
  list.forEach(seg=>{
    const now = typeof age==='number' && age>=seg.startAge && age<seg.startAge+10;
    const div=document.createElement('div'); div.className='luck-seg'+(now?' luck-now':'');
    div.innerHTML=`<div class="seg-t">Age ${seg.startAge}‚Äì${seg.startAge+9}</div>
      <div class="seg-g">${(seg.stem||'')+(seg.branch||'')}</div>
      ${seg.tenGod?`<div class="seg-s">${seg.tenGod}</div>`:''}`;
    root.appendChild(div);
  });
}
function calcAge(iso){if(!iso) return null; const b=new Date(iso+'T00:00:00'); const n=new Date(); let a=n.getFullYear()-b.getFullYear(); const m=n.getMonth()-b.getMonth(); if(m<0||(m===0&&n.getDate()<b.getDate())) a--; return a;}

function renderReading6(sections){
  const root=el('#sections'); root.innerHTML='';
  const order=[
    ["core","Your Unique Traits"],
    ["balance","Finding Balance in Life"],
    ["tengods","Understanding Your Ten Gods"],
    ["luck","Your Luck Cycle"],
    ["wellness","Wellness Suggestions"],
    ["summary","Summary of Insights"]
  ];
  order.forEach(([k,title])=>{
    const t=sections?.[k]; if(!t) return;
    const box=document.createElement('div'); box.className='card section';
    box.innerHTML=`<div class="kicker">SECTION</div><h3 class="headline">${esc(title)}</h3><div style="white-space:pre-wrap;opacity:.95">${esc(t)}</div>`;
    root.appendChild(box);
  });
}

/* ---------- synthesize 6 sections if backend doesn't send them ---------- */
function synthesizeSections(ctx,out){
  // very lightweight rule-based write-up (>=4 sentences each)
  const dm = ctx?.pillars?.day?.stem || '';
  const dmElem = STEM_ELEM[dm]||'';
  const elem = ctx?.elements||{};
  const top = Object.entries(elem).sort((a,b)=>b[1]-a[1]).map(([k])=>k);
  const hi = top[0]||'', lo = top[4]||'';
  const luckNow = (ctx?.luck?.bigLuck||[]).find(({startAge})=>{
    const a=calcAge(ctx?.birthDateISO); return typeof a==='number'&&a>=startAge&&a<startAge+10;
  });

  const elemWord = e=>({wood:'Wood',fire:'Fire',earth:'Earth',metal:'Metal',water:'Water'}[e]||e);
  const dmText = dm ? `As a Day Master represented by ${dm} (${elemWord(dmElem)}), you tend to express the qualities of ${dmElem}.` : '';
  const core = [
    `${dmText} Your chart shows a blend of strengths you can apply in daily life.`,
    `You naturally lean toward ${elemWord(hi)} qualities right now, while ${elemWord(lo)} appears comparatively quieter.`,
    `This combination can shape how you communicate, plan, and make decisions.`,
    `Leaning into your strengths while gently developing the quieter areas will keep you balanced and effective.`
  ].join(' ');

  const balance = [
    `Your elemental balance highlights ${elemWord(hi)} as a leading force with room to cultivate ${elemWord(lo)}.`,
    `Build balance through simple routines: colors, environments, or activities associated with ${elemWord(lo)}.`,
    `For example, choose hobbies, foods, or nature time that symbolize this element to steadily nourish it.`,
    `Small, consistent changes will keep your energy stable across relationships and work.`
  ].join(' ');

  const tg = ctx?.tenGods?.summary || 'Your Ten Gods suggest how you relate to power, resources, expression, and support.';
  const tengods = [
    tg,
    `Notice which roles feel most natural‚Äîleading, collaborating, researching, or crafting‚Äîand align your efforts with them.`,
    `Use supportive roles around you to complement your style and avoid doing everything alone.`,
    `As your circumstances shift, your Ten Gods profile becomes a helpful compass for choosing next steps.`
  ].join(' ');

  const luck = [
    luckNow ? `Your current 10-year cycle (Age ${luckNow.startAge}‚Äì${luckNow.startAge+9}) emphasizes ${(luckNow.tenGod||'growth and learning').toLowerCase()}.` : `Your luck cycles move in 10-year phases; each brings different opportunities.`,
    `Treat each phase like a theme year: double down on what is supported and keep experiments lightweight elsewhere.`,
    `Mark gentle checkpoints each quarter to adjust plans to real-world feedback.`,
    `This rhythm will help you ride momentum without burning out.`
  ].join(' ');

  const wellness = [
    `Well-being stabilizes when the quieter element‚Äî${elemWord(lo)}‚Äîgets steady attention.`,
    `Pair focused work with grounding breaks to keep mental clarity and emotional ease.`,
    `Sleep, hydration, and light movement form the base; a tiny habit every day beats a big burst once a month.`,
    `As balance improves, you‚Äôll notice clearer thinking and more consistent energy.`
  ].join(' ');

  const summary = [
    `In short, lead with ${elemWord(hi)} while nurturing ${elemWord(lo)}.`,
    `Use your Ten Gods strengths to choose roles that fit; invite support for the rest.`,
    `Follow the current luck theme with a simple quarterly rhythm.`,
    `Consistency over intensity will help your talents compound over time.`
  ].join(' ');

  return { core, balance, tengods, luck, wellness, summary };
}

/* ---------- Chat (Ask) ---------- */
(function chatInit(){
  const log=el('#chatLog'), input=el('#chatInput'), send=el('#chatSend'), err=el('#chatError');
  function add(role,text){
    const row=document.createElement('div'); row.className='chat-row '+(role==='user'?'chat-user':'chat-ai');
    const b=document.createElement('div'); b.className='chat-bubble'; b.textContent=text; row.appendChild(b);
    log.appendChild(row); log.scrollTop=log.scrollHeight;
  }
  async function ask(){
    const q=input.value.trim(); if(!q) return; add('user',q); input.value=''; err.textContent='';
    const ctx=window.__latestCalcContext||null;
    if(!ctx){ add('assistant','Please run ‚ÄúCalculate & Generate‚Äù first so I can read your chart.'); return; }
    try{
      const r=await fetch('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({question:q,context:ctx})});
      const j=await r.json();
      if(!j.ok){ err.textContent='Failed to get an answer. Try again.'; add('assistant','Hmm, I couldn‚Äôt reach the assistant. Please try again.'); return; }
      add('assistant',j.answer);
    }catch(e){ err.textContent=e?.message||'Network error'; add('assistant','Network error ‚Äî please try again.'); }
  }
  send.addEventListener('click',ask);
  input.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); ask(); }});
})();

/* ---------- Topic buttons ‚Üí inject prompt to chat ---------- */
const topicBtns = [
  ['#tWealth', "Based on my chart, what are the next 6‚Äì12 months like for income and savings? Include helpful timing windows if any."],
  ['#tLove', "From my Saju chart, what can I expect in love & relationships this year? Any good timing to meet someone or strengthen a bond?"],
  ['#tCareer', "According to my chart, what career path or pivot fits me better now ‚Äî leadership vs craft? Any suggested timing to make a change?"],
  ['#tHealth', "Looking at my elements, what lifestyle or wellness routines should I focus on for better balance?"],
  ['#tFamily', "Any insights around family/children based on my chart? Consider both dynamics and timing."],
  ['#tTravel', "Is there a favorable period for travel or relocation in the next 12 months? Any cautions?"],
  ['#tLearn', "What should I study or upskill next to play to my strengths?"],
  ['#tTiming', "What short-term timing windows look promising for a small personal goal or launch?"]
];
topicBtns.forEach(([sel, prompt])=>{
  const btn=el(sel); if(!btn) return;
  btn.addEventListener('click',()=>{ el('#chatInput').value=prompt; el('#chatSend').click(); });
});

/* ---------- main flow ---------- */
el('#fillBtn').addEventListener('click',()=>{
  el('#year').value='1989'; el('#month').value='10'; el('#day').value='20'; el('#hour').value='06'; el('#minute').value='00'; el('#city').value='seoul';
});

el('#calcBtn').addEventListener('click', async ()=>{
  const Y=el('#year').value, M=el('#month').value, D=el('#day').value;
  const birthDateISO = `${Y}-${M}-${D}`;
  const birthTime = `${el('#hour').value}:${el('#minute').value}`;
  const city = el('#city').value.trim();
  if(!city){ setStatus('Please enter a birth city (English).','err'); return; }

  // Step 1: geo-timezone
  setStatus('Step 1/3: Resolving city ‚Üí timezone‚Ä¶');
  const geo = await fetchJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`);
  el('#dbgGeo').textContent = `geo-timezone\n${geo.raw}`;
  if(!geo.ok||!geo.data?.timezone){ setStatus('Failed on Step 1 (geo-timezone).','err'); return; }
  const { lat, lng } = geo.data.location; const tzId = geo.data.timezone;

  // Step 2: calc
  setStatus('Step 2/3: Calculating pillars/elements‚Ä¶');
  const calcPayload = { birthDateISO, birthTime, tzId, lat, lng, timeAccuracy:'exact' };
  const calc = await fetchJSON('/api/calc',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(calcPayload)});
  el('#dbgCalc').textContent = `calc\n${calc.raw}`;
  if(!calc.ok||!calc.data?.data){ setStatus('Failed on Step 2 (calc).','err'); return; }

  const d = calc.data.data||{};
  const { pillars, elements, luck, tenGods, hiddenStems, interactions } = d;
  renderPillars(pillars,elements);
  renderLuck(luck,birthDateISO);

  // Ask Ïª®ÌÖçÏä§Ìä∏ Ï†ÄÏû• (chatÏóêÏÑú ÏÇ¨Ïö©)
  window.__latestCalcContext = {
    birthDateISO, birthTime, tzId, lat, lng,
    pillars, elements, tenGods, hiddenStems, interactions, luck
  };

  // Step 3: reading (long / 6 sections)
  setStatus('Step 3/3: Generating English reading‚Ä¶');
  const read = await fetchJSON('/api/reading-generate',{
    method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({
      pillars,elements,tenGods,interactions,
      type:'summary',locale:'en-US',length:'long',maxBullets:6,
      wantSections:true
    })
  });
  el('#dbgRead').textContent = `reading\n${read.raw}`;
  if(!read.ok||!read.data){ setStatus('Failed on Step 3 (reading).','err'); return; }

  const out = read.data.output || {};
  el('#readTitle').textContent = out.title || 'Your Saju Reading';
  el('#readBullets').innerHTML = (out.bullets||[]).map(b=>`<li>${b}</li>`).join('');
  if(out.actions&&out.actions[0]){ el('#readTry').style.display='block'; el('#readTry').innerHTML=`<strong>Try:</strong> ${out.actions[0]}`; }
  else { el('#readTry').style.display='none'; }

  // ‚úÖ ÏÑπÏÖò: ÏÑúÎ≤Ñ ‚Üí ÏóÜÏúºÎ©¥ ÌîÑÎ°†Ìä∏ Ìï©ÏÑ±
  const sectionsFromServer = read.data.sections || out.sections;
  const sections = sectionsFromServer || synthesizeSections(window.__latestCalcContext, out);
  renderReading6(sections);

  setStatus(`Done ‚Ä¢ tz: ${tzId} ‚Ä¢ lat:${(+lat).toFixed(4)}, lng:${(+lng).toFixed(4)}`,'ok');
});
</script>
</body>
</html>
