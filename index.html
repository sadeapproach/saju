<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saju‚ÄëEight ‚Ä¢ End‚Äëto‚ÄëEnd Playground (Extended)</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap">

  <style>
    :root { --bg:#0b1220; --panel:#121a2a; --muted:#6b7a90; --txt:#e9f0ff; --accent:#66b3ff; --ok:#49d39a; --err:#ff7a7a; }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:linear-gradient(120deg,#0b1220,#0e2342);color:var(--txt)}
    .wrap{max-width:980px;margin:36px auto;padding:0 16px}
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:14px 16px;box-shadow:0 10px 40px rgba(0,0,0,.35);margin-top:12px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .controls{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,button,textarea{width:100%;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0b1426;color:var(--txt);outline:none}
    button{background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:700;cursor:pointer;border:none}
    button[disabled]{opacity:.6;cursor:not-allowed}
    .muted{color:var(--muted);font-size:13px}
    .kicker{font-size:12px;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);margin-bottom:6px}
    .headline{font-size:20px;font-weight:800;margin:0 0 6px}
    .row{display:flex;gap:10px;align-items:center}
    .row-sb{display:flex;gap:10px;align-items:center;justify-content:space-between}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);font-size:12px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    ul{padding-left:18px;margin:8px 0 0}
    .gauge{display:flex;height:10px;overflow:hidden;border-radius:10px;border:1px solid #2a2a2a;margin-top:12px}
    .gauge>div{height:100%}
    .wood{background:#16a34a}.fire{background:#ef4444}.earth{background:#f59e0b;color:#111}.metal{background:#e5e7eb;color:#111;border-color:#cbd5e1}.water{background:#06b6d4}
    .pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    .pillar{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:16px;padding:12px}
    .pillar-title{font-size:12px;opacity:.8;text-align:center;margin-bottom:6px}
    .box{height:70px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:700;border:1px solid #0003}
    .chips{display:flex;flex-wrap:wrap;gap:6px;justify-content:center;margin-top:6px}
    .chip{font-size:11px;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1)}
    .topics{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
    @media (max-width:780px){.controls{grid-template-columns:repeat(2,1fr)}.topics{grid-template-columns:repeat(2,1fr)}.pillars{grid-template-columns:repeat(2,1fr)}}
    .topic{padding:12px;border:1px solid rgba(255,255,255,.08);border-radius:14px;background:rgba(255,255,255,.04)}
    .topic h4{margin:0 0 6px;font-size:14px}
    .topic small{display:block;color:var(--muted);margin-bottom:8px}
    .askbox{display:grid;grid-template-columns:1fr 80px;gap:8px;margin-top:8px}
    .chat{display:flex;flex-direction:column;gap:8px;margin-top:8px;max-height:300px;overflow:auto}
    .msg{padding:10px 12px;border-radius:12px;max-width:80%}
    .me{align-self:flex-end;background:#2a3955}
    .ai{align-self:flex-start;background:#162033}
    .errline{color:var(--err);font-size:13px;margin-top:6px}
    .toast{position:fixed;right:16px;bottom:16px;background:#162033;border:1px solid rgba(255,255,255,.12);color:var(--txt);padding:10px 12px;border-radius:10px;box-shadow:0 8px 24px rgba(0,0,0,.4)}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Controls -->
    <div class="card">
      <div class="controls">
        <div><label>Birth year</label><select id="ySel"></select></div>
        <div><label>Birth month</label><select id="mSel"></select></div>
        <div><label>Birth day</label><select id="dSel"></select></div>
        <div><label>Hour</label><select id="hSel"></select></div>
        <div><label>Minute</label><select id="minSel"></select></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><label>Birth city (in English)</label><input id="city" placeholder="Seoul / New York / Tokyo" /></div>
        <div>
          <label>&nbsp;</label>
          <div class="row"><button id="runBtn">Calculate & Generate</button><button id="fillExample" type="button" style="background:#7fb3ff;color:#081123">Fill Example</button></div>
        </div>
      </div>
      <div id="status" class="muted" style="margin-top:8px;"></div>
      <details style="margin-top:6px"><summary class="muted">What happens under the hood?</summary>
        <ul class="muted">
          <li>GET <code>/api/geo-timezone</code> ‚Üí tzId</li>
          <li>POST <code>/api/calc</code> ‚Üí pillars, elements, luck ...</li>
          <li>POST <code>/api/reading-generate</code> ‚Üí English reading</li>
        </ul>
      </details>
    </div>

    <!-- Pillars -->
    <div id="pillarsCard" class="card" style="display:none"></div>

    <!-- Big Luck -->
    <div id="luckCard" class="card" style="display:none"></div>

    <!-- Reading -->
    <div id="readingCard" class="card" style="display:none"></div>

    <!-- Topic grid -->
    <div id="topicsCard" class="card" style="display:none"></div>

    <!-- Ask (chat) -->
    <div id="askCard" class="card" style="display:none">
      <div class="kicker">Ask about your Saju</div>
      <div class="muted">Ask me anything about timing, relationships, career, or health. I‚Äôll use your current chart as context.</div>
      <div id="chat" class="chat"></div>
      <div class="askbox">
        <input id="askInput" placeholder="e.g., When is a good time to change jobs?" />
        <button id="askBtn">Ask</button>
      </div>
      <div id="askErr" class="errline" style="display:none"></div>
    </div>

    <!-- Debug -->
    <details class="card"><summary>Debug JSON (geo/calc/reading)</summary>
      <pre id="dbgGeo" class="muted"></pre>
      <pre id="dbgCalc" class="muted"></pre>
      <pre id="dbgRead" class="muted"></pre>
    </details>
  </div>

  <div id="toast" class="toast" style="display:none"></div>

<script>
/* ---------- Utilities ---------- */
const el = q => document.querySelector(q);
const statusEl = el('#status');
const toastEl  = el('#toast');
function showToast(msg){ toastEl.textContent = msg; toastEl.style.display='block'; setTimeout(()=>toastEl.style.display='none', 2200); }
function setStatus(msg,type=''){ statusEl.innerHTML = msg; statusEl.className='muted '+(type||''); }

/* ÏïàÏ†Ñ ÌååÏÑú: JSON ÏïÑÎãê ÎïåÎèÑ raw Î≥¥Ï°¥ */
async function safeFetchJSON(url, opts={}){
  let r, t;
  try{
    r = await fetch(url, opts);
    t = await r.text();
  }catch(e){
    return { ok:false, status:0, data:null, raw:String(e||'fetch_failed') };
  }
  let data = null;
  try{ data = JSON.parse(t); }catch{ /* keep null */ }
  return { ok: r.ok && !!data, status:r.status, data, raw:t };
}

/* ---------- Selects (YM D H m) ---------- */
(function initSelectors(){
  const ySel = el('#ySel'), mSel = el('#mSel'), dSel = el('#dSel'), hSel = el('#hSel'), minSel = el('#minSel');
  const now = new Date().getFullYear();
  for(let y=now; y>=1900; y--) ySel.insertAdjacentHTML('beforeend', `<option>${y}</option>`);
  for(let m=1;m<=12;m++) mSel.insertAdjacentHTML('beforeend', `<option>${String(m).padStart(2,'0')}</option>`);
  for(let d=1;d<=31;d++) dSel.insertAdjacentHTML('beforeend', `<option>${String(d).padStart(2,'0')}</option>`);
  for(let h=0;h<24;h++) hSel.insertAdjacentHTML('beforeend', `<option>${String(h).padStart(2,'0')}</option>`);
  for(let i=0;i<60;i+=5) minSel.insertAdjacentHTML('beforeend', `<option>${String(i).padStart(2,'0')}</option>`);

  // defaults
  ySel.value = '1992'; mSel.value = '06'; dSel.value='02'; hSel.value='09'; minSel.value='00';
})();

/* ---------- Renderers ---------- */
const STEM_ELEM = {Áî≤:"wood",‰πô:"wood",‰∏ô:"fire",‰∏Å:"fire",Êàä:"earth",Â∑±:"earth",Â∫ö:"metal",Ëæõ:"metal",Â£¨:"water",Áô∏:"water"};
const BRANCH_ELEM={Â≠ê:"water",‰∏ë:"earth",ÂØÖ:"wood",ÂçØ:"wood",Ëæ∞:"earth",Â∑≥:"fire",Âçà:"fire",Êú™:"earth",Áî≥:"metal",ÈÖâ:"metal",Êàå:"earth",‰∫•:"water"};
const COLOR_CLASS={wood:"wood",fire:"fire",earth:"earth",metal:"metal",water:"water"};

function renderPillars(pillars,elements,tenGods,hiddenStems){
  const root = el('#pillarsCard');
  if(!pillars){ root.style.display='none'; return; }
  root.style.display='block';
  root.innerHTML = `
    <div class="kicker">FOUR PILLARS</div>
    <div class="pillars">
      ${["hour","day","month","year"].map(k=>{
        const p = pillars[k]; if(!p) return '';
        const stemClass = COLOR_CLASS[STEM_ELEM[p.stem]]||'wood';
        const brClass   = COLOR_CLASS[BRANCH_ELEM[p.branch]]||'earth';
        const tg = (tenGods?.byPillar?.[k] || tenGods?.[k] || tenGods?.[k+'Stem']) || '';
        const hs = hiddenStems?.[p.branch] || hiddenStems?.byBranch?.[p.branch] || [];
        const title = ({hour:'Hour Pillar (ÏãúÏ£º)',day:'Day Pillar (ÏùºÏ£º)',month:'Month Pillar (ÏõîÏ£º)',year:'Year Pillar (ÎÖÑÏ£º)'}[k]);
        return `
          <div class="pillar">
            <div class="pillar-title">${title}</div>
            ${k==='day'?'<div class="muted" style="text-align:center;margin-bottom:6px">Day Master (Self) / ÏùºÍ∞Ñ(ÎÇò)</div>':''}
            <div class="box ${stemClass}">${p.stem}</div>
            <div class="box ${brClass}" style="margin-top:8px">${p.branch}</div>
            ${tg?`<div class="chips"><span class="chip">${tg}</span></div>`:''}
            ${Array.isArray(hs)&&hs.length?`<div class="chips">${hs.map(h=>`<span class="chip">${h}</span>`).join('')}</div>`:''}
          </div>`;
      }).join('')}
    </div>
    ${elements?`<div class="gauge" style="margin-top:10px">${["wood","fire","earth","metal","water"].map(e=>{const pct=Math.max(2,Math.round((elements[e]||0)*100));return `<div class="${COLOR_CLASS[e]}" style="width:${pct}%"></div>`}).join('')}</div>`:''}
  `;
}

function renderLuck(luck,birthDateISO){
  const root = el('#luckCard');
  const list = luck?.bigLuck || [];
  if(!Array.isArray(list)||!list.length){ root.style.display='none'; return; }
  root.style.display='block';
  const age = (function(b){const d=new Date(b+'T00:00:00');const n=new Date();let a=n.getFullYear()-d.getFullYear();const m=n.getMonth()-d.getMonth();if(m<0||(m===0&&n.getDate()<d.getDate()))a--;return a})(birthDateISO);
  root.innerHTML = `
    <div class="kicker">BIG LUCK (10-year cycles)</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      ${list.map(({startAge,stem,branch,tenGod})=>{
        const now = typeof age==='number' && age>=startAge && age<startAge+10;
        return `<div style="flex:1;min-width:110px;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:8px;background:rgba(255,255,255,.05);${now?'outline:2px solid #66b3ff;box-shadow:0 0 0 4px rgba(102,179,255,.2)':''}">
          <div class="muted">Age ${startAge}‚Äì${startAge+9}</div>
          <div style="font-weight:800;font-size:16px;margin-top:2px">${(stem||'')+(branch||'')}</div>
          ${tenGod?`<div class="muted" style="font-size:12px;margin-top:2px">${tenGod}</div>`:''}
        </div>`
      }).join('')}
    </div>`;
}

function renderReading(output, meta={}){
  const root = el('#readingCard'); root.style.display='block';
  const pill = meta.fallback?'<span class="pill">Fallback</span>':meta.mocked?'<span class="pill">Mock</span>':'<span class="pill ok">Live</span>';
  root.innerHTML = `
    <div class="row-sb">
      <div class="kicker">READING</div>
      <div>${pill}</div>
    </div>
    <h3 class="headline">${output.title || 'Your Saju Reading'}</h3>
    ${Array.isArray(output.bullets)?`<ul>${output.bullets.map(b=>`<li>${b}</li>`).join('')}</ul>`:''}
    ${output.forecastOneLiner?`<div class="muted" style="margin-top:8px">${output.forecastOneLiner}</div>`:''}
    ${Array.isArray(output.sections)?output.sections.map(s=>`
      <div style="margin-top:10px">
        <div class="kicker">SECTION</div>
        <div style="font-weight:800;margin-bottom:4px">${s.title||''}</div>
        <div class="muted">${(s.body||'').replace(/\n/g,'<br>')}</div>
      </div>`).join(''):''}
  `;
}

function renderTopics(){
  const root = el('#topicsCard'); root.style.display='block';
  const topics = [
    {key:'wealth', icon:'üí∞', title:'Wealth & Money', sub:'Income, savings, timing.'},
    {key:'love', icon:'‚ù§Ô∏è', title:'Love & Relationships', sub:'Compatibility, meeting timing.'},
    {key:'career', icon:'üß≠', title:'Career & Growth', sub:'Fit, leadership vs craft, pivots.'},
    {key:'health', icon:'üåø', title:'Health & Wellness', sub:'Imbalance ‚Üí care routines.'},
    {key:'family', icon:'üë∂', title:'Family & Children', sub:'Fertility & family dynamics.'},
    {key:'travel', icon:'‚úàÔ∏è', title:'Travel / Relocation', sub:'Good periods, cautions.'},
    {key:'learning', icon:'üìö', title:'Learning & Skills', sub:'What to study, deepen talent.'},
    {key:'timing', icon:'‚è±Ô∏è', title:'Timing & Windows', sub:'Short‚Äëterm chances.'},
  ];
  root.innerHTML = `
    <div class="kicker">EXPLORE SPECIFIC FORTUNES</div>
    <div class="topics">
      ${topics.map(t=>`
        <div class="topic">
          <h4>${t.icon} ${t.title}</h4>
          <small>${t.sub}</small>
          <button data-topic="${t.key}" class="seeBtn">See insights</button>
          <div id="topic-${t.key}" class="muted" style="white-space:pre-wrap;margin-top:8px"></div>
        </div>`).join('')}
    </div>`;
  root.querySelectorAll('.seeBtn').forEach(btn=>{
    btn.addEventListener('click', ()=> handleTopic(btn.getAttribute('data-topic')));
  });
}

function pushMsg(role,text){
  const c = el('#chat'); const div = document.createElement('div');
  div.className = 'msg '+(role==='user'?'me':'ai'); div.textContent = text; c.appendChild(div); c.scrollTop = c.scrollHeight;
}

function askError(msg){ const e=el('#askErr'); e.textContent = msg; e.style.display='block'; setTimeout(()=>e.style.display='none',2500); }

/* ---------- Global chart cache ---------- */
let G = { geo:null, calc:null, read:null };

/* ---------- Button actions ---------- */
el('#fillExample').addEventListener('click', ()=>{
  el('#ySel').value='1989'; el('#mSel').value='10'; el('#dSel').value='20'; el('#hSel').value='06'; el('#minSel').value='00';
  el('#city').value='seoul';
});

el('#runBtn').addEventListener('click', runAll);
el('#askBtn').addEventListener('click', doAsk);

async function runAll(){
  const y=el('#ySel').value, m=el('#mSel').value, d=el('#dSel').value;
  const hh=el('#hSel').value, mm=el('#minSel').value;
  const city = el('#city').value.trim();
  if(!y || !m || !d || !city){ setStatus('Please fill Y/M/D and city.','err'); return; }

  const birthDateISO = `${y}-${m}-${d}`;
  const birthTime = `${hh}:${mm}`;

  // Step 1
  setStatus('Step 1/3: Resolving city ‚Üí timezone‚Ä¶');
  const geo = await safeFetchJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`);
  el('#dbgGeo').textContent = 'geo-timezone\n'+(geo.data?JSON.stringify(geo.data,null,2):geo.raw);
  if(!geo.ok || !geo.data?.timezone){ setStatus('Failed on Step 1 (geo-timezone).','err'); showToast(geo.data?.error||'Network error'); return; }
  const { lat, lng } = geo.data.location; const tzId = geo.data.timezone;

  // Step 2
  setStatus('Step 2/3: Calculating pillars/elements‚Ä¶');
  const calc = await safeFetchJSON('/api/calc',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ birthDateISO, birthTime, lat, lng, tzId, timeAccuracy:'exact' })
  });
  el('#dbgCalc').textContent = 'calc\n'+(calc.data?JSON.stringify(calc.data,null,2):calc.raw);
  if(!calc.ok || !calc.data?.data){ setStatus('Failed on Step 2 (calc).','err'); showToast(calc.data?.error||'Server error'); return; }

  const dcalc = calc.data.data || {};
  const { pillars, elements, tenGods, hiddenStems, interactions, luck } = dcalc;
  renderPillars(pillars, elements, tenGods, hiddenStems);
  renderLuck(luck, birthDateISO);

  // Step 3
  setStatus('Step 3/3: Generating English reading‚Ä¶');
  const read = await safeFetchJSON('/api/reading-generate', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({ pillars, elements, tenGods, interactions, type:'summary', locale:'en-US', length:'long', maxBullets:6 })
  });
  el('#dbgRead').textContent = 'reading\n'+(read.data?JSON.stringify(read.data,null,2):read.raw);
  if(!read.ok || !read.data?.output){ setStatus('Failed on Step 3 (reading).','err'); showToast(read.data?.error||'LLM error'); return; }

  renderReading(read.data.output, { fallback: read.data.fallback, mocked: read.data.mocked });
  renderTopics();
  el('#askCard').style.display='block';

  setStatus(`Done ‚Ä¢ tz: ${tzId} ‚Ä¢ lat:${lat.toFixed(4)}, lng:${lng.toFixed(4)}`, 'ok');

  // cache for topic/ask
  G = { geo:geo.data, calc:dcalc, read:read.data, meta:{ birthDateISO, birthTime, tzId } };
}

async function handleTopic(topicKey){
  if(!G?.calc?.pillars){ showToast('Run Calculate first.'); return; }
  const target = el(`#topic-${topicKey}`); target.textContent = 'Loading‚Ä¶';
  const resp = await safeFetchJSON('/api/topic-insight', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      topic: topicKey,
      pillars: G.calc.pillars,
      elements: G.calc.elements,
      tenGods: G.calc.tenGods,
      interactions: G.calc.interactions,
      luck: G.calc.luck,
      locale:'en-US'
    })
  });
  if(!resp.ok){ target.textContent = `‚ö†Ô∏è ${resp.data?.error || 'Network error'}\n${resp.raw?.slice(0,160)}`; return; }
  target.textContent = resp.data.output || '(empty)';
}

async function doAsk(){
  const q = el('#askInput').value.trim();
  if(!q) return;
  if(!G?.calc?.pillars){ askError('Run Calculate first.'); return; }
  pushMsg('user', q);
  el('#askInput').value='';

  const resp = await safeFetchJSON('/api/ask', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      question: q,
      pillars: G.calc.pillars,
      elements: G.calc.elements,
      tenGods: G.calc.tenGods,
      interactions: G.calc.interactions,
      luck: G.calc.luck,
      locale:'en-US'
    })
  });

  if(!resp.ok){
    pushMsg('assistant', `‚ö†Ô∏è ${resp.data?.error || 'Network error'}\n${(resp.raw||'').slice(0,180)}`);
    return;
  }
  pushMsg('assistant', resp.data.output || '(empty)');
}
</script>
</body>
</html>
