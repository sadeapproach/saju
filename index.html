<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Saju‑Eight • Playground</title>
  <style>
    :root { --bg:#0b1220; --panel:#121a2a; --muted:#6b7a90; --txt:#e9f0ff; --accent:#66b3ff; --ok:#49d39a; --err:#ff7a7a; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background: linear-gradient(120deg,#0b1220,#0e2342); color:var(--txt); }
    .wrap { max-width: 980px; margin: 48px auto; padding: 0 20px; }
    .title { font-size: 28px; font-weight: 800; letter-spacing: .3px; margin-bottom: 16px; }
    .sub { color: var(--muted); margin-bottom: 28px; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    .card { background: rgba(255,255,255,.04); border: 1px solid rgba(255,255,255,.08); border-radius: 16px; padding: 18px; box-shadow: 0 10px 40px rgba(0,0,0,.35); }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, select, button, textarea {
      width: 100%; padding: 12px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,.12);
      background: #0b1426; color: var(--txt); outline: none;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(102,179,255,.2); }
    button { background: linear-gradient(135deg,#4da3ff,#66b3ff); color:#06101d; font-weight: 700; cursor: pointer; border: none; }
    button[disabled] { opacity: .6; cursor: not-allowed; }
    .actions { display:flex; gap:10px; margin-top: 12px; }
    .muted { color: var(--muted); font-size: 13px; }
    .row { display:flex; gap:12px; align-items:center; }
    .row > * { flex: 1; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); font-size:12px; }
    .ok { color: var(--ok); } .err { color: var(--err); }
    .result { margin-top: 18px; }
    .kicker { font-size: 12px; letter-spacing: .16em; text-transform: uppercase; color: var(--muted); margin-bottom: 6px; }
    .headline { font-size: 22px; font-weight: 800; margin: 0 0 8px; }
    ul { padding-left: 18px; margin: 8px 0 0; }
    .one { margin-top: 8px; font-style: italic; color:#cfe4ff; }
    .callout { margin-top: 10px; padding: 10px 12px; background: rgba(73,211,154,.09); border: 1px solid rgba(73,211,154,.25); border-radius: 12px; }
    details { margin-top: 12px; }
    pre { background: #081123; border:1px solid rgba(255,255,255,.08); padding: 12px; border-radius: 12px; overflow:auto; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Saju‑Eight • End‑to‑End Playground</div>
    <div class="sub">Enter birth info and city → we’ll resolve timezone, compute pillars, and generate an English reading.</div>

    <div class="card" id="formCard">
      <div class="grid">
        <div>
          <label>Birth date (YYYY‑MM‑DD)</label>
          <input id="birthDate" placeholder="1992-06-02" />
        </div>
        <div>
          <label>Birth time (HH:mm, optional)</label>
          <input id="birthTime" placeholder="09:00 (or leave blank)" />
        </div>
      </div>
      <div class="grid">
        <div>
          <label>Birth city (in English)</label>
          <input id="city" placeholder="Seoul / New York / Tokyo" />
        </div>
        <div>
          <label>Time accuracy</label>
          <select id="accuracy">
            <option value="exact">Exact time</option>
            <option value="approx">Approximate</option>
            <option value="unknown">Unknown</option>
          </select>
        </div>
      </div>

      <div class="actions">
        <button id="runBtn">Calculate & Generate</button>
        <button id="fillExample" type="button">Fill Example</button>
      </div>
      <div id="status" class="muted" style="margin-top:8px;"></div>

      <details>
        <summary class="muted">What happens under the hood?</summary>
        <ul class="muted">
          <li>Step 1: GET <code>/api/geo-timezone?city=...</code> → latitude/longitude + <em>tzId</em></li>
          <li>Step 2: POST <code>/api/calc</code> → pillars & elements (mock for now)</li>
          <li>Step 3: POST <code>/api/reading-generate</code> → short English reading JSON</li>
        </ul>
      </details>
    </div>

    <div class="result" id="result"></div>
  </div>

<script>
const el = (q) => document.querySelector(q);
const statusEl = el('#status');
const resultEl = el('#result');
const runBtn = el('#runBtn');

el('#fillExample').addEventListener('click', () => {
  el('#birthDate').value = '1992-06-02';
  el('#birthTime').value = '09:00';
  el('#city').value = 'New York';
  el('#accuracy').value = 'exact';
});

function setStatus(msg, type='') {
  statusEl.innerHTML = msg;
  statusEl.className = 'muted ' + (type || '');
}

async function fetchJSON(url, opts={}) {
  const r = await fetch(url, opts);
  const text = await r.text();
  try { return { ok:r.ok, status:r.status, data: JSON.parse(text), raw:text }; }
  catch { return { ok:r.ok, status:r.status, data: null, raw:text }; }
}

function renderReading(output, meta={}) {
  const { badge, share } = output.cards || {};
  const isFallback = meta.fallback || false;
  const mocked = meta.mocked || false;
  const pill = isFallback ? `<span class="pill">Fallback</span>` : mocked ? `<span class="pill">Mock</span>` : `<span class="pill ok">Live</span>`;

  resultEl.innerHTML = `
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div class="kicker">Reading</div>
        <div>${pill}</div>
      </div>
      <h3 class="headline">${output.title || 'Your Saju Reading'}</h3>
      <ul>
        ${(output.bullets || []).map(b => `<li>${b}</li>`).join('')}
      </ul>
      <div class="one">${output.forecastOneLiner || ''}</div>
      ${Array.isArray(output.actions) && output.actions[0] ? `<div class="callout"><strong>Try:</strong> ${output.actions[0]}</div>` : ''}
      ${badge || (share?.headline) ? `
        <div class="row" style="margin-top:10px">
          ${badge ? `<span class="pill">${badge}</span>` : ``}
          ${share?.headline ? `<span class="muted">${share.headline} — ${share.sub || ''}</span>` : ``}
        </div>` : ``}
    </div>
  `;
}

runBtn.addEventListener('click', async () => {
  const birthDateISO = el('#birthDate').value.trim();
  const birthTime = el('#birthTime').value.trim();
  const city = el('#city').value.trim();
  const timeAccuracy = el('#accuracy').value;

  if (!birthDateISO || !city) {
    setStatus('Please fill birth date and city.', 'err'); return;
  }

  runBtn.disabled = true;
  setStatus('Step 1/3: Resolving city → timezone…');

  // Step 1: city → lat/lng/timezone
  const geo = await fetchJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`);
  if (!geo.ok || !geo.data?.timezone) {
    setStatus('Failed on Step 1 (geo-timezone). Check city spelling or try again.', 'err');
    runBtn.disabled = false; return;
  }

  const { lat, lng } = geo.data.location;
  const tzId = geo.data.timezone;

  setStatus('Step 2/3: Calculating pillars/elements…');
  const calcPayload = { birthDateISO, birthTime: birthTime || null, lat, lng, tzId, timeAccuracy };
  const calc = await fetchJSON('/api/calc', {
    method: 'POST', headers: { 'Content-Type':'application/json' },
    body: JSON.stringify(calcPayload)
  });
  if (!calc.ok || !calc.data?.data) {
    setStatus('Failed on Step 2 (calc).', 'err'); runBtn.disabled = false; return;
  }

  const { pillars, elements } = calc.data.data;

  setStatus('Step 3/3: Generating English reading…');
  const read = await fetchJSON('/api/reading-generate', {
    method: 'POST', headers: { 'Content-Type':'application/json' },
    body: JSON.stringify({ pillars, elements, type:'summary', locale:'en-US' })
  });

  if (!read.ok || !read.data) {
    setStatus('Failed on Step 3 (reading).', 'err'); runBtn.disabled = false; return;
  }

  const out = read.data.output || read.data.output; // either live or fallback/mock shares 'output'
  renderReading(out, { fallback: read.data.fallback, mocked: read.data.mocked });

  setStatus(`Done • tz: ${tzId} • lat:${lat.toFixed(4)}, lng:${lng.toFixed(4)}`, 'ok');

  // Show raw JSON for debugging
  resultEl.insertAdjacentHTML('beforeend', `
    <details class="card" style="margin-top:12px">
      <summary>Debug JSON (geo/calc/reading)</summary>
      <pre>geo-timezone\n${JSON.stringify(geo.data, null, 2)}</pre>
      <pre>calc\n${JSON.stringify(calc.data, null, 2)}</pre>
      <pre>reading\n${JSON.stringify(read.data, null, 2)}</pre>
    </details>
  `);

  runBtn.disabled = false;
});
</script>
</body>
</html>
