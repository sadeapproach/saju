<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sajuâ€‘Eight â€¢ Endâ€‘toâ€‘End Playground</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0b1220;--panel:#121a2a;--muted:#8aa0c3;--txt:#ecf2ff;--accent:#66b3ff;--ok:#49d39a;--err:#ff7a7a}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(120deg,#0b1220,#0e2342);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,Arial}
.wrap{max-width:1060px;margin:28px auto 80px;padding:0 18px}
.h1{font-size:26px;font-weight:800;margin:6px 0 8px}
.sub{color:var(--muted);margin-bottom:18px}
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);margin-top:12px}
.section-title{font-size:12px;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin:0 0 8px}
.row{display:flex;gap:10px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
select,button,input{background:#0b1426;color:var(--txt);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;outline:none}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px #66b3ff33}
button{background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:800;border:none;cursor:pointer}
button[disabled]{opacity:.6;cursor:not-allowed}
.help{color:var(--muted);font-size:13px;margin-top:6px}
/* pillars */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pcard{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
.ptitle{font-size:12px;color:#a9bce3;margin-bottom:6px;text-align:center}
.box{height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:800;border:1px solid #0003}
.subline{font-size:11px;color:#cfe4ff;text-align:center;margin-top:6px}
.wood{background:#16a34a;color:#fff}.fire{background:#ef4444;color:#fff}
.earth{background:#f59e0b;color:#111}.metal{background:#e5e7eb;color:#111;border-color:#cbd5e1}
.water{background:#06b6d4;color:#fff}
/* big luck */
.luckbar{display:flex;gap:8px}
.lseg{flex:1;min-width:84px;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:rgba(255,255,255,.05)}
.lh{font-size:12px;opacity:.85;margin-bottom:2px}
.lgan{font-weight:800}
.lnow{outline:2px solid var(--accent);box-shadow:0 0 0 4px #66b3ff33}
/* reading */
.block{background:#14213d;border:1px solid #2c4168;border-radius:10px;padding:12px;margin-top:10px}
.btitle{color:#a9d6ff;font-weight:800;margin-bottom:6px}
.bsubtitle{color:#9dc6ff;font-size:12px;margin:-2px 0 8px;opacity:.9}
.bul{padding-left:18px;margin:6px 0}
.call{margin-top:10px;padding:10px 12px;background:#49d39a18;border:1px solid #49d39a55;border-radius:10px}
/* fortunes */
.fgrid{display:grid;grid-template-columns:1fr;gap:10px}
.ftile{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
.ftop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.fleft{display:flex;align-items:center;gap:10px}
.ficon{font-size:24px}
.fname{font-weight:700}
.fhint{font-size:12px;color:var(--muted)}
.fcontent{margin-top:10px;display:none}
.closewrap{display:flex;justify-content:flex-end}
.closebtn{margin-top:16px;background:#22314c;border:1px solid #2c4168;color:#cfe2ff;padding:8px 10px;border-radius:8px}
/* chat */
.chat{background:#0f1a30;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;height:220px;overflow:auto}
.msg{max-width:78%;padding:10px 12px;border-radius:10px;line-height:1.45;font-size:14px}
.me{align-self:flex-end;background:#3a86ff;color:#081326}
.bot{align-self:flex-start;background:#14213d;border:1px solid #2c4168}
.inputrow{display:flex;gap:8px;margin-top:8px}
.text{flex:1}
.small{font-size:12px;color:var(--muted)}
.err{color:var(--err)}.ok{color:var(--ok)}
@media(min-width:760px){.grid2{grid-template-columns:repeat(5,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">Sajuâ€‘Eight â€¢ Endâ€‘toâ€‘End Playground</div>
  <div class="sub">Enter birth info â†’ timezone â†’ pillars â†’ 6â€‘section reading â†’ explore specific fortunes â†’ ask followâ€‘ups (with chart context).</div>

  <div class="card">
    <div class="grid2">
      <select id="yy"></select>
      <select id="mm"></select>
      <select id="dd"></select>
      <select id="hh"></select>
      <select id="min"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="city" class="text" placeholder="Seoul / New York / Tokyo"/>
      <button id="run">Calculate & Generate</button>
      <button id="fill" type="button">Fill Example</button>
    </div>
    <div id="status" class="help"></div>
  </div>

  <div class="card">
    <div class="section-title">Four Pillars</div>
    <div id="pillars" class="pillars"></div>
  </div>

  <div class="card">
    <div class="section-title">Big Luck (10â€‘year cycles)</div>
    <div id="luck" class="luckbar"></div>
  </div>

  <div class="card">
    <div class="section-title">Reading</div>
    <div id="reading"></div>
  </div>

  <div class="card">
    <div class="section-title">Explore Specific Fortunes</div>
    <div id="fgrid" class="fgrid"></div>
  </div>

  <div class="card">
    <div class="section-title">Ask About Your Saju</div>
    <div id="chat" class="chat"></div>
    <div class="inputrow">
      <input id="ask" class="text" placeholder="Type your questionâ€¦"/>
      <button id="askBtn">Ask</button>
    </div>
    <div class="small">Iâ€™ll use your current chart as context.</div>
  </div>

  <details class="card">
    <summary>Debug JSON (geo/calc/reading)</summary>
    <pre id="dbg" style="white-space:pre-wrap"></pre>
  </details>
</div>

<script>
/* ---------- util ---------- */
const Q = (s)=>document.querySelector(s);
const S = (s)=>document.querySelectorAll(s);
const statusEl = Q('#status'), dbgEl=Q('#dbg');

function setStatus(msg,type=''){ statusEl.textContent=msg; statusEl.className='help '+(type||''); }

async function fetchJSON(url,opt){
  try{
    const r=await fetch(url,opt); const txt=await r.text();
    let data=null; try{ data=JSON.parse(txt) }catch{}
    return { ok:r.ok && !!data, status:r.status, data, raw:txt };
  }catch(e){ return { ok:false, status:0, data:null, raw:String(e&&e.message||e) }; }
}

function yyyy(n){return String(n).padStart(4,'0')}
function dd(n){return String(n).padStart(2,'0')}
function age(b){const d=new Date(b+"T00:00:00");const n=new Date();let a=n.getFullYear()-d.getFullYear();const m=n.getMonth()-d.getMonth(); if(m<0||(m===0&&n.getDate()<d.getDate())) a--; return a;}

(function initSelects(){
  const y=Q('#yy'), m=Q('#mm'), d=Q('#dd'), h=Q('#hh'), mi=Q('#min');
  for(let i=1940;i<=2025;i++) y.appendChild(new Option(i,i));
  for(let i=1;i<=12;i++) m.appendChild(new Option(dd(i),dd(i)));
  for(let i=1;i<=31;i++) d.appendChild(new Option(dd(i),dd(i)));
  for(let i=0;i<24;i++) h.appendChild(new Option(dd(i),dd(i)));
  for(let i=0;i<60;i+=5) mi.appendChild(new Option(dd(i),dd(i)));
  y.value='1989'; m.value='10'; d.value='20'; h.value='06'; mi.value='00';
})();
</script>

<script>
/* ---------- safe markdown ---------- */
function asString(x){
  if (x==null) return '';
  if (typeof x==='string') return x;
  if (typeof x==='number' || typeof x==='boolean') return String(x);
  if (Array.isArray(x)) return x.map(asString).join('\n');
  const cand = x.text||x.summary||x.body||x.html||x.overview||'';
  return typeof cand==='string' ? cand : '';
}
function md(s=''){
  const raw = asString(s);
  if(!raw) return '';
  let t = raw.replace(/\r\n/g,'\n').trim();
  t = t.replace(/^### +(.+)$/gm,'<div class="btitle">$1</div>')
       .replace(/^## +(.+)$/gm,'<div class="btitle">$1</div>')
       .replace(/^# +(.+)$/gm,'<div class="btitle">$1</div>');
  t = t.split(/\n\n+/).map(block=>{
    const b = block.trim();
    if (/^(\-|\u2022) /.test(b)) {
      return '<ul class="bul">' + b.split('\n')
        .map(l=>l.replace(/^(\-|\u2022) +/, ''))
        .map(x=>`<li>${x}</li>`).join('') + '</ul>';
    }
    return `<p>${b}</p>`;
  }).join('');
  return t.replace(/\*\*(.+?)\*\*/g,'<b>$1</b>');
}
</script>

<script>
/* ---------- pillars & luck ---------- */
const STEM_ELEM = {ç”²:"wood",ä¹™:"wood",ä¸™:"fire",ä¸:"fire",æˆŠ:"earth",å·±:"earth",åºš:"metal",è¾›:"metal",å£¬:"water",ç™¸:"water"};
const BRANCH_ELEM={å­:"water",ä¸‘:"earth",å¯…:"wood",å¯:"wood",è¾°:"earth",å·³:"fire",åˆ:"fire",æœª:"earth",ç”³:"metal",é…‰:"metal",æˆŒ:"earth",äº¥:"water"};
const colorCls = ch => (STEM_ELEM[ch]||BRANCH_ELEM[ch]||'wood');

function renderPillars(pillars, tenGods){
  const root=Q('#pillars'); root.innerHTML='';
  (['hour','day','month','year']).forEach(k=>{
    const p=pillars?.[k]; if(!p) return;
    const god = (tenGods?.byPillar?.[k] || tenGods?.[k] || '');
    const title = k==='day'?'Day Pillar (ì¼ì£¼) Â· Day Master'
                : k==='hour'?'Hour Pillar (ì‹œì£¼)'
                : k==='month'?'Month Pillar (ì›”ì£¼)'
                : 'Year Pillar (ë…„ì£¼)';
    const div=document.createElement('div'); div.className='pcard';
    div.innerHTML = `
      <div class="ptitle">${title}</div>
      <div class="box ${colorCls(p.stem)}">${p.stem||'?'}</div>
      <div class="box ${colorCls(p.branch)}" style="margin-top:8px">${p.branch||'?'}</div>
      ${god?`<div class="subline">${god}</div>`:''}
    `;
    root.appendChild(div);
  });
}
function renderLuck(luck, birthISO){
  const root=Q('#luck'); root.innerHTML='';
  const list=luck?.bigLuck||[]; if(!list.length) return;
  const a=age(birthISO);
  list.forEach(({startAge,stem,branch,tenGod})=>{
    const seg=document.createElement('div');
    const now= typeof a==='number' && a>=startAge && a<startAge+10;
    seg.className='lseg '+(now?'lnow':'');
    seg.innerHTML=`<div class="lh">Age ${startAge}â€“${startAge+9}</div>
      <div class="lgan">${stem||''}${branch||''}</div>
      ${tenGod?`<div class="small">${tenGod}</div>`:''}`;
    root.appendChild(seg);
  });
}
</script>

<script>
/* ---------- READING ë Œë”ëŸ¬ (7ì„¹ì…˜ + êµ¬ë²„ì „ í˜¸í™˜) ---------- */
function adaptOldReading(old) {
  if (!old || Array.isArray(old)) return null;
  const out = {
    pillars: old.pillars || "",
    day_master: old.day_master || old.core || "",
    five_elements: old.five_elements || old.balance || "",
    structure: old.structure || old.tengods || "",
    yongshin: old.yongshin || "",
    life_flow: old.life_flow || old.luck || "",
    summary: old.summary || ""
  };
  return out;
}
const READING_META = [
  ['pillars','ë‹¹ì‹ ì˜ ë„¤ ê¸°ë‘¥ ìš”ì•½','íƒœì–´ë‚œ ì—°Â·ì›”Â·ì¼Â·ì‹œì˜ ì²œê°„Â·ì§€ì§€ë¡œ ë³´ëŠ” ì „ì²´ êµ¬ì¡°'],
  ['day_master','ë‚˜ë¥¼ ëŒ€í‘œí•˜ëŠ” ê¸°ìš´','ì¼ê°„(ë‚˜ì˜ ê¸°ë³¸ ì„±í–¥) ì¤‘ì‹¬ìœ¼ë¡œ ì„±ê²©Â·ëŒ€ì¸ê´€ê³„Â·í–‰ë™ ìŠµê´€'],
  ['five_elements','ì˜¤í–‰ì˜ ê· í˜•','ëª©Â·í™”Â·í† Â·ê¸ˆÂ·ìˆ˜ì˜ ê°•ì•½ê³¼ ì¡°í™”, ìƒí™œ ë³´ì™„ í¬ì¸íŠ¸'],
  ['structure','ê¸°ë³¸ ìš´ì„¸ êµ¬ì¡°','ê²©êµ­ ê´€ì ì˜ ë°©í–¥ì„±(ì¬ë¬¼Â·ëª…ì˜ˆÂ·í•™ìŠµ ë“±)'],
  ['yongshin','ë³´ì™„ í‚¤ì›Œë“œ(ìš©ì‹ )','ë¶€ì¡±/ê³¼ë‹¤í•œ ê¸°ìš´ì„ ë‹¤ë“¬ëŠ” í•µì‹¬ í‚¤ì›Œë“œ'],
  ['life_flow','ì‚¶ì˜ í° íë¦„','ì´ˆë…„Â·ì¤‘ë…„Â·ë§ë…„ì˜ ê¸°íšŒì™€ ì£¼ì˜ì '],
  ['summary','í•œëˆˆì— ë³´ëŠ” ì¥ë‹¨ì ','ê°•ì Â·ì•½ì  ìš”ì•½ + ì˜¤ëŠ˜ë¶€í„° ì‹¤ì²œ í•œ ì¤„']
];
function renderReading7(sectionsIn){
  const root=Q('#reading'); root.innerHTML='';
  let model=null;
  if (sectionsIn && !Array.isArray(sectionsIn) &&
      ('pillars' in sectionsIn || 'day_master' in sectionsIn || 'five_elements' in sectionsIn)) {
    model = sectionsIn;
  } else {
    model = adaptOldReading(sectionsIn);
  }
  if(!model){
    root.innerHTML = '<div class="block"><div class="btitle">Reading</div><div>ì´ë²ˆì—ëŠ” ë¦¬ë”©ì„ ë§Œë“¤ì§€ ëª»í–ˆì–´ìš”.</div></div>';
    return;
  }
  READING_META.forEach(([key,title,subtitle])=>{
    const text = model[key] || '';
    const empty = !(text && String(text).trim().length>0);
    const div=document.createElement('div'); div.className='block';
    div.innerHTML = `
      <div class="btitle">${title}</div>
      <div class="bsubtitle">${subtitle}</div>
      <div>${ empty ? '<span class="small" style="opacity:.7">í‘œì‹œí•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.</span>' : md(text) }</div>
    `;
    root.appendChild(div);
  });
}
</script>

<script>
/* ---------- Specific Fortunes (ê¸°ì¡´ ìœ ì§€) ---------- */
const TOPIC_ALIASES = {
  wealth:['wealth','money','finance','wealth_money','money_wealth'],
  love:['love','relationships','love_relationships','romance','relationship_love'],
  career:['career','growth','career_growth'],
  health:['health','wellness','health_wellness'],
  family:['family','children','family_children'],
  travel:['travel','relocation','travel_relocation','move'],
  learning:['learning','skills','learning_skills','study'],
  timing:['timing','windows','timing_windows','luck_windows'],
};
const TOPICS = [
  {key:'wealth', icon:'ğŸ’°', name:'Wealth & Money', hint:'Income, savings, timing.'},
  {key:'love', icon:'â¤ï¸', name:'Love & Relationships', hint:'Compatibility, timing.'},
  {key:'career', icon:'ğŸ§°', name:'Career & Growth', hint:'Fit, leadership vs craft.'},
  {key:'health', icon:'ğŸŒ¿', name:'Health & Wellness', hint:'Imbalance â†’ care.'},
  {key:'family', icon:'ğŸ‘¶', name:'Family & Children', hint:'Fertility & dynamics.'},
  {key:'travel', icon:'âœˆï¸', name:'Travel / Relocation', hint:'Good periods, cautions.'},
  {key:'learning', icon:'ğŸ“˜', name:'Learning & Skills', hint:'What to study.'},
  {key:'timing', icon:'â±ï¸', name:'Timing & Windows', hint:'Shortâ€‘term chances.'},
];
function mountFortuneGrid(){
  const g=Q('#fgrid'); if(!g) return;
  g.innerHTML='';
  TOPICS.forEach(t=>{
    const card=document.createElement('div'); card.className='ftile'; card.dataset.key=t.key;
    card.innerHTML=`
      <div class="ftop">
        <div class="fleft">
          <div class="ficon">${t.icon}</div>
          <div>
            <div class="fname">${t.name}</div>
            <div class="fhint">${t.hint}</div>
          </div>
        </div>
        <button class="see">See insights</button>
      </div>
      <div class="fcontent"></div>
    `;
    g.appendChild(card);
  });
  g.querySelectorAll('.see').forEach(btn=>{
    btn.addEventListener('click',()=>expandTopic(btn.closest('.ftile')));
  });
}
function showFortuneError(content,label,resp){
  const message = (resp && resp.data && (resp.data.error||resp.data.message))
               || (resp && resp.raw) || 'Network error â€” please try again.';
  const status  = resp && resp.status ? `status: ${resp.status}` : '';
  content.innerHTML = `
    <div class="block" style="border-color:#f59e0b80">
      <div class="btitle">${label}</div>
      <div class="err">Network / Server error</div>
      <div class="small" style="margin-top:6px">${status}</div>
      <pre class="small" style="white-space:pre-wrap;margin-top:8px;background:#0b1426;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:8px">${String(message).slice(0,1200)}</pre>
      <div class="closewrap"><button class="closebtn">Close</button></div>
    </div>`;
  content.style.display='block';
  const close=content.querySelector('.closebtn');
  if(close) close.addEventListener('click',()=>{content.style.display='none';});
}
function mdFortune(s){ return (typeof s==='string'?s:String(s||''))
  .replace(/\r\n/g,'\n').trim()
  .replace(/^### +(.+)$/gm,'<div class="btitle">$1</div>')
  .replace(/\*\*(.+?)\*\*/g,'<b>$1</b>')
  .replace(/^(\-|\u2022) (.+)$/gm,'â€¢ $2'); }
function countElementsFromPillars(pillars){
  const map={wood:0,fire:0,earth:0,metal:0,water:0};
  const push=(ch)=>{const e=STEM_ELEM[ch]||BRANCH_ELEM[ch]; if(e) map[e]++;};
  if(!pillars) return map;
  ['hour','day','month','year'].forEach(k=>{
    const p=pillars[k]; if(!p) return; push(p.stem); push(p.branch);
  });
  return map;
}
function currentLuckInfo(luck, birthISO){
  const a=age(birthISO); let cur=null,next=null;
  const list=luck?.bigLuck||[];
  for(const seg of list){ if(a>=seg.startAge && a<seg.startAge+10) cur=seg; }
  if(cur){ next=list.find(x=>x.startAge===cur.startAge+10)||null; } else { next=list[0]||null; }
  return {cur,next,age:a};
}
function extractFortuneBlocks(o){
  if (!o) return [];
  const asText = (v)=>{
    if(!v) return '';
    if(typeof v==='string') return v.trim();
    if(Array.isArray(v)) return v.map(x=>asText(x)).filter(Boolean).map(x=>`â€¢ ${x}`).join('\n');
    return (v.text||v.body||v.html||v.markdown||v.content||'').toString().trim();
  };
  const pushIf=(arr,title,val)=>{const t=asText(val); if(t) arr.push({title,body:t});};
  const blocks=[];
  pushIf(blocks,'Overview', o.overview||o.summary||o.intro||o.description||o.content||o.answer||o.result);
  pushIf(blocks,'Key Phases', o.phases||o.keyPhases||o.key_points||o.keyPoints||o.points);
  pushIf(blocks,'Watch Out', o.watch||o.watchOut||o.cautions||o.risks||o.pitfalls||o.avoid);
  pushIf(blocks,'Tips', o.tips||o.recommendations||o.advice||o.actions);
  if (o.sections && typeof o.sections==='object'){
    const M=o.sections; pushIf(blocks,'Overview', M.overview); pushIf(blocks,'Key Phases', M.phases);
    pushIf(blocks,'Watch Out', M.watch); pushIf(blocks,'Tips', M.tips);
  }
  if (Array.isArray(o.cards)) o.cards.forEach(c=>pushIf(blocks, c.title||c.kicker||'Insight', c.body||c.text||c));
  if (Array.isArray(o.blocks)) o.blocks.forEach(b=>pushIf(blocks, b.title||'Insight', b.body||b.text||b));
  if (!blocks.length){
    const raw = o.markdown || o.html || o.text || o.content || o.answer || o.result;
    if (typeof raw==='string' && raw.trim()) blocks.push({title:'Overview', body:raw.trim()});
  }
  return blocks;
}
function synthesizeFortune(frontKey, ctx){
  const out=[];
  const pillars=ctx?.pillars||{};
  const em=countElementsFromPillars(pillars);
  const dom=Object.entries(em).sort((a,b)=>b[1]-a[1])[0]?.[0]||'';
  const {cur,next,age}=currentLuckInfo(ctx?.luck, ctx?.birthDateISO);
  const curStr = cur ? `${cur.startAge}â€“${cur.startAge+9} (${cur.stem||''}${cur.branch||''})` : 'N/A';
  const nxtStr = next ? `${next.startAge}â€“${next.startAge+9} (${next.stem||''}${next.branch||''})` : 'N/A';
  const open = `This is a practical snapshot built from your chart context (age ${age}). Dominant element looks like **${dom || 'mixed'}**. Current luck decade: **${curStr}**, next: **${nxtStr}**.`;
  const topicHints = {
    wealth:{phases:`â€¢ When Output/Influence dominates (like ${cur?.tenGod||'certain decades'}), lean into visibility and pitching.\nâ€¢ ${next?`Next decade ${nxtStr} may favor switching vehicles or new income lines.`:''}`,watch:`â€¢ Avoid overâ€‘leveraging during Metalâ€‘leaning months if cashflow is uneven.\nâ€¢ Keep an emergency buffer (3â€“6 months).`,tips:`â€¢ Budget by **quarters**; review monthly.\nâ€¢ Batch big expenses outside peak busy months.\nâ€¢ Track one KPI: saving rate or debtâ€‘toâ€‘income.`},
    love:{phases:`â€¢ Social/Peerâ€‘heavy luck windows support dating & networking.\nâ€¢ Quiet months are better for clarifying nonâ€‘negotiables.`,watch:`â€¢ Donâ€™t make lifetime decisions under short â€œhighâ€ transits.\nâ€¢ Balance work/output so energy is left for relationships.`,tips:`â€¢ Plan **lowâ€‘friction** dates; prioritize routine over intensity.\nâ€¢ Review expectations every quarter; communicate early.`},
    career:{phases:`â€¢ Output decades (ì‹ìƒ) â†’ build portfolio & ship.\nâ€¢ Authority decades (ê´€) â†’ step up to leadership and process.`,watch:`â€¢ Donâ€™t overcommit across cycles; protect recovery weeks.\nâ€¢ Say â€œnoâ€ to roles that drain your dayâ€‘master element.`,tips:`â€¢ One focus per quarter.\nâ€¢ Keep a brag doc; update after each delivery.\nâ€¢ Practice weekly â€œdemoâ€.`},
    health:{phases:`â€¢ Earthâ€‘heavy periods: support digestion & regularity.\nâ€¢ Fireâ€‘heavy: hydrate/sleep; calm the nervous system.`,watch:`â€¢ Overwork during Output spikes â†’ track fatigue.\nâ€¢ Mind late nights around month changes.`,tips:`â€¢ Daily walk â­\nâ€¢ Sleep window anchor.\nâ€¢ Quarterly labs if you push hard at work.`},
    family:{phases:`â€¢ Stable Earth/Metal months favor planning & paperwork.\nâ€¢ Water/Wood months are smoother for transitions.`,watch:`â€¢ Donâ€™t compress major moves with career sprints.\nâ€¢ Share logistics early with family.`,tips:`â€¢ Create a shared calendar.\nâ€¢ Budget a â€œbuffer weekâ€ for any big change.`},
    travel:{phases:`â€¢ Move/relocation: aim for steadyâ€‘support months (fewer surprises).\nâ€¢ Short trips fit well in Outputâ€‘light weeks.`,watch:`â€¢ Avoid backâ€‘toâ€‘back obligations within 7 days of moving.\nâ€¢ Doubleâ€‘check docs in Mercuryâ€‘style retro cycles.`,tips:`â€¢ Batch paperwork; keep copies in cloud.\nâ€¢ Pad 1â€“2 buffer days around the move.`},
    learning:{phases:`â€¢ Resource decades (ì¸ì„±) are ideal for deep study.\nâ€¢ Peer/output decades â†’ learn by shipping.`,watch:`â€¢ Beware course hopping; set an outcome per quarter.`,tips:`â€¢ Pick **one stack**.\nâ€¢ Weekly 2Ã—90 min focus sessions.\nâ€¢ Publish a miniâ€‘project monthly.`},
    timing:{phases:`â€¢ Use the **current luck decade** tailwinds (${curStr}).\nâ€¢ Microâ€‘windows: quiet weeks after new moons or postâ€‘holiday lulls.`,watch:`â€¢ Donâ€™t force starts during family/health spikes.\nâ€¢ Respect your recovery weeks.`,tips:`â€¢ Plan by quarters; preview the next 6 weeks every Sunday.\nâ€¢ Keep a small â€œoptionalityâ€ buffer.`}
  }[frontKey]||{phases:`â€¢ Ride stable months for starts; use noisy months for drafts.\nâ€¢ Align big calls with your recovery patterns.`,watch:`â€¢ Avoid stacking multiple firsts in one week.`,tips:`â€¢ Quarter plan, weekly review, daily minimums.`};
  out.push({title:'Overview', body:open});
  out.push({title:'Key Phases', body:topicHints.phases});
  out.push({title:'Watch Out', body:topicHints.watch});
  out.push({title:'Tips', body:topicHints.tips});
  return out;
}
async function callFortuneAPI(frontKey){
  const ctx = window.__chartCtx || null;
  const names = TOPIC_ALIASES[frontKey] || [frontKey];
  const attempts = [];
  names.forEach(n=>{
    attempts.push({m:'GET', url:`/api/ask?topic=${encodeURIComponent(n)}&mode=fortune`});
    attempts.push({m:'GET', url:`/api/ask?category=${encodeURIComponent(n)}&mode=fortune`});
    attempts.push({m:'GET', url:`/api/ask?type=${encodeURIComponent(n)}&mode=fortune`});
    attempts.push({m:'GET', url:`/api/ask?k=${encodeURIComponent(n)}&mode=fortune`});
  });
  names.forEach(n=>{
    attempts.push({m:'GET', url:`/api/fortune?topic=${encodeURIComponent(n)}`});
    attempts.push({m:'GET', url:`/api/fortune?category=${encodeURIComponent(n)}`});
    attempts.push({m:'GET', url:`/api/fortune?type=${encodeURIComponent(n)}`});
    attempts.push({m:'GET', url:`/api/fortune?k=${encodeURIComponent(n)}`});
  });
  names.forEach(n=>{
    attempts.push({m:'POST', url:'/api/ask', body:{topic:n, mode:'fortune', ctx}});
    attempts.push({m:'POST', url:'/api/ask', body:{category:n, mode:'fortune', ctx}});
    attempts.push({m:'POST', url:'/api/ask', body:{type:n, mode:'fortune', ctx}});
    attempts.push({m:'POST', url:'/api/ask', body:{k:n, mode:'fortune', ctx}});
  });
  names.forEach(n=>{
    attempts.push({m:'POST', url:'/api/fortune', body:{topic:n, ctx}});
    attempts.push({m:'POST', url:'/api/fortune', body:{category:n, ctx}});
    attempts.push({m:'POST', url:'/api/fortune', body:{type:n, ctx}});
    attempts.push({m:'POST', url:'/api/fortune', body:{k:n, ctx}});
  });
  let lastResp=null;
  for (const a of attempts){
    try{
      const opt = a.m==='POST' ? {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(a.body||{})} : {};
      const r = await fetchJSON(a.url, opt);
      lastResp = r;
      if (r.ok && (r.data?.ok!==false) && (r.data?.output || r.data?.data)){
        const out = r.data.output || r.data.data;
        return {ok:true, out, meta:a};
      }
    }catch(e){ lastResp = {ok:false,status:0,raw:String(e)}; }
  }
  return {ok:false, lastResp};
}
async function expandTopic(card){
  if (!card || card.dataset.loading === '1') return;
  card.dataset.loading = '1';
  const key=card.dataset.key;
  const btn=card.querySelector('.see');
  const content=card.querySelector('.fcontent');
  if (btn) { btn.disabled=true; btn.textContent='Loadingâ€¦'; }
  try{
    const res = await callFortuneAPI(key);
    let blocks = [];
    if (res.ok){ blocks = extractFortuneBlocks(res.out||[]); }
    const meaningful = blocks.some(b=> (b.body||'').trim().length>0 );
    if (!meaningful){ blocks = synthesizeFortune(key, window.__chartCtx || {}); }
    content.innerHTML =
      blocks.map(b=>`
        <div class="block">
          ${b.title?`<div class="btitle">${b.title}</div>`:''}
          <div>${mdFortune(b.body||'')}</div>
        </div>`).join('')
      + `<div class="closewrap"><button class="closebtn">Close</button></div>`;
    content.style.display='block';
    if (btn) btn.style.display='none';
    const cbtn = content.querySelector('.closebtn');
    if (cbtn) cbtn.addEventListener('click',()=>{content.style.display='none'; if(btn) btn.style.display='inline-block';});
  }catch(e){
    showFortuneError(content, 'Specific Fortune', {raw:String(e)});
  }finally{
    if (btn){ btn.disabled=false; btn.textContent='See insights'; }
    delete card.dataset.loading;
  }
}
if (document.querySelector('#fgrid')) { mountFortuneGrid(); }
</script>

<script>
/* ---------- ask (ì¼ê´€ í†¤ í…œí”Œë¦¿ ì£¼ì…) ---------- */
function addMsg(text,who='bot'){
  const p=document.createElement('div'); p.className='msg '+(who==='me'?'me':'bot'); p.innerHTML=md(text);
  const box=Q('#chat'); box.appendChild(p); box.scrollTop=box.scrollHeight;
}
function summarizeChart(ctx){
  if(!ctx) return 'No chart context.';
  const p=ctx.pillars||{};
  const hour=`${p.hour?.stem||''}${p.hour?.branch||''}`.trim();
  const day =`${p.day?.stem||''}${p.day?.branch||''}`.trim();
  const month=`${p.month?.stem||''}${p.month?.branch||''}`.trim();
  const year=`${p.year?.stem||''}${p.year?.branch||''}`.trim();
  const em=countElementsFromPillars(p);
  const dom=Object.entries(em).sort((a,b)=>b[1]-a[1])[0]?.[0]||'mixed';
  const {cur}=currentLuckInfo(ctx.luck, ctx.birthDateISO);
  const luckStr = cur? `${cur.startAge}â€“${cur.startAge+9} ${cur.stem||''}${cur.branch||''} (${cur.tenGod||''})` : 'N/A';
  return `Pillars: Hour ${hour}, Day ${day}, Month ${month}, Year ${year}. Dominant element: ${dom}. Current luck decade: ${luckStr}.`;
}
function buildAskPrompt(q, ctx){
  const summary=summarizeChart(ctx);
  return [
    'You are a Saju/Bazi guide. Tone: clear, warm, practical. Avoid jargon; if needed, explain briefly.',
    'Format:',
    'â€¢ Direct answer first (2â€“4 sentences).',
    'â€¢ Then 3â€“5 bullets of actionable tips.',
    'â€¢ Add 1 â€œTimingâ€ hint only if relevant.',
    '',
    'Chart context:',
    summary,
    '',
    'User question:',
    q
  ].join('\n');
}
async function ask(q){
  addMsg(q,'me');
  try{
    const payload = { q: buildAskPrompt(q, window.__chartCtx||null), mode:'chat', ctx:window.__chartCtx||null };
    let r = await fetchJSON('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
    if(!r.ok || (!r.data?.ok && !r.data?.output)){
      r = await fetchJSON(`/api/ask?q=${encodeURIComponent(payload.q)}`);
    }
    if(!r.ok||(!r.data?.ok && !r.data?.output)){ addMsg("I couldnâ€™t quite catch that. Could you rephrase your question? ğŸ™‚"); return; }
    addMsg(r.data.output||"Hereâ€™s my take based on your chart.");
  }catch{ addMsg("âš ï¸ Network error â€” please try again."); }
}
</script>

<script>
/* ---------- main flow ---------- */
Q('#fill').addEventListener('click',()=>{
  Q('#yy').value='1989'; Q('#mm').value='10'; Q('#dd').value='20'; Q('#hh').value='06'; Q('#min').value='00';
  Q('#city').value='seoul';
});
Q('#askBtn').addEventListener('click',()=>{
  const v=Q('#ask').value.trim(); if(!v) return; Q('#ask').value=''; ask(v);
});

/* NEW: ì½ê¸° ì „ìš© ë„ìš°ë¯¸ - ì—¬ëŸ¬ í˜•íƒœì˜ ì‘ë‹µì—ì„œ output ì¶”ì¶œ */
function pickReadingOutput(respData){
  if (!respData) return null;
  // ê°€ì¥ í”í•œ ê²½ë¡œë“¤
  return respData.output
      || respData.sections
      || (respData.data && (respData.data.output || respData.data.sections))
      || null;
}

/* NEW: ì—¬ëŸ¬ payload ì‹œë„ */
async function fetchReading({pillars,elements,tenGods,interactions,luck}){
  const attempts = [
    {body:{pillars,elements,tenGods,interactions,mode:'structured',locale:'ko-KR'}},
    {body:{chart:{pillars,elements,tenGods,interactions,luck}, mode:'structured', locale:'ko-KR', schema:'v2'}},
    {body:{data:{pillars,elements,tenGods,interactions,luck}, locale:'ko-KR'}},
    {get:true}
  ];
  let last=null;
  for (const a of attempts){
    try{
      let r;
      if (a.get){
        r = await fetchJSON('/api/reading-generate?mode=structured');
      }else{
        r = await fetchJSON('/api/reading-generate',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(a.body)});
      }
      last=r;
      if (r.ok){
        const out = pickReadingOutput(r.data);
        if (out) return {ok:true, out, raw:r.data};
      }
    }catch(e){
      last = {ok:false,status:0,raw:String(e)};
    }
  }
  return {ok:false, last};
}

Q('#run').addEventListener('click', async ()=>{
  const yy=Q('#yy').value, mm=Q('#mm').value, ddv=Q('#dd').value, hh=Q('#hh').value, mi=Q('#min').value;
  const city=Q('#city').value.trim();
  if(!city){ setStatus('Please enter a birth city.', 'err'); return; }
  const birthDateISO=`${yyyy(yy)}-${mm}-${ddv}`;
  const birthTime=`${hh}:${mi}`;

  setStatus('Step 1/3: Resolving city â†’ timezoneâ€¦');
  const geo=await fetchJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`);
  if(!geo.ok||!geo.data?.timezone){ setStatus('Failed on Step 1 (geo-timezone).','err'); return; }
  const {lat,lng}=geo.data.location; const tzId=geo.data.timezone;

  setStatus('Step 2/3: Calculating pillarsâ€¦');
  const calc=await fetchJSON('/api/calc',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({birthDateISO,birthTime,lat,lng,tzId,timeAccuracy:'exact'})});
  if(!calc.ok||!calc.data?.data){ setStatus('Failed on Step 2 (calc).','err'); return; }
  const d=calc.data.data||{}; const {pillars,elements,tenGods,interactions,luck}=d;

  renderPillars(pillars,tenGods);
  renderLuck(luck,birthDateISO);

  window.__chartCtx = { pillars, elements, tenGods, luck, birthDateISO, tzId, lat, lng };

  setStatus('Step 3/3: Generating structured readingâ€¦');

  const read = await fetchReading({pillars,elements,tenGods,interactions,luck});
  if(!read.ok){
    setStatus('Failed on Step 3 (reading).','err');
    // ì½ê¸° ì¹´ë“œì— ì—ëŸ¬ë„ í‘œì‹œ
    const rbox = Q('#reading');
    rbox.innerHTML = `<div class="block">
      <div class="btitle">Reading error</div>
      <div class="small">Cannot build reading. Check server log or payload mapping.</div>
      <pre class="small" style="white-space:pre-wrap;background:#0b1426;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:8px;margin-top:8px;">${read.last ? (read.last.raw || JSON.stringify(read.last.data||{},null,2)) : 'No response'}</pre>
    </div>`;
    // ë””ë²„ê·¸ íƒ­ì—ë„ ë‚¨ê¹€
    dbgEl.textContent = 'geo-timezone\n'+JSON.stringify(geo.data,null,2)
      +'\n\ncalc\n'+JSON.stringify(calc.data,null,2)
      +'\n\nreading (failed)\n'+JSON.stringify(read.last && read.last.data || {},null,2);
    return;
  }

  renderReading7(read.out);

  setStatus(`Done â€¢ tz: ${tzId} â€¢ lat:${lat.toFixed(4)}, lng:${lng.toFixed(4)}`,'ok');

  mountFortuneGrid();

  dbgEl.textContent = 'geo-timezone\n'+JSON.stringify(geo.data,null,2)
    +'\n\ncalc\n'+JSON.stringify(calc.data,null,2)
    +'\n\nreading\n'+JSON.stringify(read.raw || read.out,null,2);
});

/* boot */
mountFortuneGrid();
addMsg("Hi! Ask me anything about timing, relationships, career, or health. Iâ€™ll use your current chart as context.",'bot');
</script>
</body>
</html>
