<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sajuâ€‘Eight â€¢ Endâ€‘toâ€‘End Playground (Stable Reset)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0b1220;--panel:#121a2a;--muted:#8aa0c3;--txt:#ecf2ff;--accent:#66b3ff;--ok:#49d39a;--err:#ff7a7a;
  --chip:#20304a;--chip-bd:#314766;
}
*{box-sizing:border-box}
body{margin:0;background:linear-gradient(120deg,#0b1220,#0e2342);color:var(--txt);font-family:ui-sans-serif,system-ui,-apple-system,"Noto Sans KR","Segoe UI",Roboto,Arial}
.wrap{max-width:1060px;margin:28px auto 80px;padding:0 18px}
.h1{font-size:26px;font-weight:800;margin:6px 0 8px}
.sub{color:var(--muted);margin-bottom:18px}

/* Card */
.card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;box-shadow:0 10px 40px rgba(0,0,0,.35);margin-top:12px}
.section-title{font-size:12px;letter-spacing:.18em;color:var(--muted);text-transform:uppercase;margin:0 0 8px}
.row{display:flex;gap:10px;align-items:center}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.grid5{display:grid;grid-template-columns:repeat(5,1fr);gap:8px}
select,button,input{background:#0b1426;color:var(--txt);border:1px solid rgba(255,255,255,.12);border-radius:10px;padding:10px 12px;outline:none}
select:focus,input:focus{border-color:var(--accent);box-shadow:0 0 0 3px #66b3ff33}
button{background:linear-gradient(135deg,#4da3ff,#66b3ff);color:#06101d;font-weight:800;border:none;cursor:pointer}
button[disabled]{opacity:.6;cursor:not-allowed}
.help{color:var(--muted);font-size:13px;margin-top:6px}

/* Pillars UI */
.pillars{display:grid;grid-template-columns:repeat(4,1fr);gap:10px}
.pcard{border:1px solid rgba(255,255,255,.08);border-radius:14px;padding:10px}
.ptitle{font-size:12px;color:#a9bce3;margin-bottom:6px;text-align:center}
.box{height:72px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:40px;font-weight:800;border:1px solid #0003}
.subline{font-size:11px;color:#cfe4ff;text-align:center;margin-top:6px}
.wood{background:#16a34a;color:#fff}.fire{background:#ef4444;color:#fff}
.earth{background:#f59e0b;color:#111}.metal{background:#e5e7eb;color:#111;border-color:#cbd5e1}
.water{background:#06b6d4;color:#fff}

/* Big Luck */
.luckbar{display:flex;gap:8px}
.lseg{flex:1;min-width:84px;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:10px;background:rgba(255,255,255,.05)}
.lh{font-size:12px;opacity:.85;margin-bottom:2px}
.lgan{font-weight:800}
.lnow{outline:2px solid var(--accent);box-shadow:0 0 0 4px #66b3ff33}

/* Reading (6 sections) */
.rhead{font-size:18px;font-weight:800;margin:4px 0 8px}
.bul{padding-left:18px;margin:6px 0}
.call{margin-top:10px;padding:10px 12px;background:#49d39a18;border:1px solid #49d39a55;border-radius:10px}

/* Specific Fortunes (1Ã—8) */
.fgrid{display:grid;grid-template-columns:1fr;gap:10px}
.ftile{border:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.04);border-radius:12px;padding:12px}
.ftop{display:flex;align-items:center;justify-content:space-between;gap:10px}
.fleft{display:flex;align-items:center;gap:10px}
.ficon{font-size:24px} /* ì•„ì´ì½˜ í¬ê²Œ */
.fname{font-weight:700}
.fhint{font-size:12px;color:var(--muted)}
.fcontent{margin-top:10px;display:none}
.block{background:#14213d;border:1px solid #2c4168;border-radius:10px;padding:12px;margin-top:10px}
.btitle{color:#a9d6ff;font-weight:800;margin-bottom:6px}
.closewrap{display:flex;justify-content:flex-end}
.closebtn{margin-top:12px;background:#22314c;border:1px solid #2c4168;color:#cfe2ff}

/* Chat */
.chat{background:#0f1a30;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px;height:340px;overflow:auto}
.msg{max-width:78%;padding:10px 12px;border-radius:10px;line-height:1.45;font-size:14px}
.me{align-self:flex-end;background:#3a86ff;color:#081326}
.bot{align-self:flex-start;background:#14213d;border:1px solid #2c4168}
.inputrow{display:flex;gap:8px;margin-top:8px}
.text{flex:1}
.small{font-size:12px;color:var(--muted)}
.err{color:var(--err)}
.ok{color:var(--ok)}
@media(min-width:760px){.grid2{grid-template-columns:repeat(5,1fr)}}
</style>
</head>
<body>
<div class="wrap">
  <div class="h1">Sajuâ€‘Eight â€¢ Endâ€‘toâ€‘End Playground</div>
  <div class="sub">Enter birth info â†’ timezone â†’ pillars â†’ 6â€‘section English reading â†’ explore specific fortunes â†’ ask followâ€‘ups.</div>

  <!-- Form -->
  <div class="card">
    <div class="grid2">
      <select id="yy"></select>
      <select id="mm"></select>
      <select id="dd"></select>
      <select id="hh"></select>
      <select id="min"></select>
    </div>
    <div class="row" style="margin-top:8px">
      <input id="city" class="text" placeholder="Seoul / New York / Tokyo"/>
      <button id="run">Calculate & Generate</button>
      <button id="fill" type="button">Fill Example</button>
    </div>
    <div id="status" class="help"></div>
  </div>

  <!-- Pillars -->
  <div class="card">
    <div class="section-title">Four Pillars</div>
    <div id="pillars" class="pillars"></div>
  </div>

  <!-- Big Luck -->
  <div class="card">
    <div class="section-title">Big Luck (10â€‘year cycles)</div>
    <div id="luck" class="luckbar"></div>
  </div>

  <!-- Reading -->
  <div class="card">
    <div class="section-title">Reading</div>
    <div id="reading"></div>
  </div>

  <!-- Specific Fortunes -->
  <div class="card">
    <div class="section-title">Explore Specific Fortunes</div>
    <div id="fgrid" class="fgrid"></div>
  </div>

  <!-- Ask -->
  <div class="card">
    <div class="section-title">Ask About Your Saju</div>
    <div id="chat" class="chat"></div>
    <div class="inputrow">
      <input id="ask" class="text" placeholder="Type your questionâ€¦"/>
      <button id="askBtn">Ask</button>
    </div>
    <div class="small">Iâ€™ll use your current chart as context.</div>
  </div>

  <!-- Debug -->
  <details class="card">
    <summary>Debug JSON (geo/calc/reading)</summary>
    <pre id="dbg" style="white-space:pre-wrap"></pre>
  </details>
</div>

<script>
/* ===== util ===== */
const Q = (s)=>document.querySelector(s);
const S = (s)=>document.querySelectorAll(s);
const statusEl = Q('#status'), dbgEl=Q('#dbg');
const STEM_ELEM = {ç”²:"wood",ä¹™:"wood",ä¸™:"fire",ä¸:"fire",æˆŠ:"earth",å·±:"earth",åºš:"metal",è¾›:"metal",å£¬:"water",ç™¸:"water"};
const BRANCH_ELEM={å­:"water",ä¸‘:"earth",å¯…:"wood",å¯:"wood",è¾°:"earth",å·³:"fire",åˆ:"fire",æœª:"earth",ç”³:"metal",é…‰:"metal",æˆŒ:"earth",äº¥:"water"};
const COLOR = {wood:"wood",fire:"fire",earth:"earth",metal:"metal",water:"water"};

function setStatus(msg,type=''){ statusEl.textContent=msg; statusEl.className='help '+(type||''); }
async function getJSON(url,opt){ const r=await fetch(url,opt); const t=await r.text(); try{ return {ok:r.ok,status:r.status,data:JSON.parse(t),raw:t}; }catch{ return {ok:r.ok,status:r.status,data:null,raw:t}; } }
function yyyy(n){return String(n).padStart(4,'0')} function dd(n){return String(n).padStart(2,'0')}
function age(b){const d=new Date(b+"T00:00:00");const n=new Date();let a=n.getFullYear()-d.getFullYear();const m=n.getMonth()-d.getMonth(); if(m<0||(m===0&&n.getDate()<d.getDate())) a--; return a;}

/* ===== form selects ===== */
(function initSelects(){
  const y=Q('#yy'), m=Q('#mm'), d=Q('#dd'), h=Q('#hh'), mi=Q('#min');
  for(let i=1940;i<=2025;i++){ const o=document.createElement('option'); o.value=o.text= i; y.appendChild(o); }
  for(let i=1;i<=12;i++){ const o=document.createElement('option'); o.value=dd(i); o.text=dd(i); m.appendChild(o); }
  for(let i=1;i<=31;i++){ const o=document.createElement('option'); o.value=dd(i); o.text=dd(i); d.appendChild(o); }
  for(let i=0;i<24;i++){ const o=document.createElement('option'); o.value=dd(i); o.text=dd(i); h.appendChild(o); }
  for(let i=0;i<60;i+=5){ const o=document.createElement('option'); o.value=dd(i); o.text=dd(i); mi.appendChild(o); }
  y.value='1989'; m.value='10'; d.value='20'; h.value='06'; mi.value='00';
})();

/* ===== renderers ===== */
function renderPillars(pillars, elements, tenGods, hiddenStems){
  const root=Q('#pillars'); root.innerHTML='';
  const order=['hour','day','month','year'];
  order.forEach(k=>{
    const p=pillars?.[k]; if(!p) return;
    const s=COLOR[STEM_ELEM[p.stem]]||'wood';
    const b=COLOR[BRANCH_ELEM[p.branch]]||'earth';
    const god=(tenGods?.byPillar?.[k]||tenGods?.[k]||'');
    const div=document.createElement('div');
    div.className='pcard';
    div.innerHTML=`
      <div class="ptitle">${k==='day'?'Day Pillar (ì¼ì£¼) Â· Day Master':''
        || (k==='hour'?'Hour Pillar (ì‹œì£¼)':k==='month'?'Month Pillar (ì›”ì£¼)':'Year Pillar (ë…„ì£¼)')}</div>
      <div class="box ${s}">${p.stem||'?'}</div>
      <div class="box ${b}" style="margin-top:8px">${p.branch||'?'}</div>
      ${god?`<div class="subline">${god}</div>`:''}
    `;
    root.appendChild(div);
  });
}
function renderLuck(luck, birthISO){
  const root=Q('#luck'); root.innerHTML='';
  const list=luck?.bigLuck||[]; if(!list.length) return;
  const a=age(birthISO);
  list.forEach(({startAge,stem,branch,tenGod})=>{
    const seg=document.createElement('div');
    const now= typeof a==='number' && a>=startAge && a<startAge+10;
    seg.className='lseg '+(now?'lnow':'');
    seg.innerHTML=`<div class="lh">Age ${startAge}â€“${startAge+9}</div>
      <div class="lgan">${stem||''}${branch||''}</div>
      ${tenGod?`<div class="small">${tenGod}</div>`:''}`;
    root.appendChild(seg);
  });
}
function hEsc(s){return (s||'').replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]))}
function renderReading6(sections){
  const root=Q('#reading'); root.innerHTML='';
  const order=['core','balance','tengods','luck','wellness','summary'];
  const titleMap={
    core:'Your Unique Traits',
    balance:'Creating Balance in Life',
    tengods:'Understanding Your Ten Gods',
    luck:'Your Luck Cycle',
    wellness:'Wellness Suggestions',
    summary:'Summary of Insights'
  };
  order.forEach(k=>{
    const sec=sections?.[k]; if(!sec) return;
    const div=document.createElement('div');
    div.className='block';
    div.innerHTML=`<div class="btitle">${titleMap[k]||k}</div>
      <div>${hEsc(sec.text||'')}</div>
      ${Array.isArray(sec.bullets)?`<ul class="bul">${sec.bullets.map(x=>`<li>${hEsc(x)}</li>`).join('')}</ul>`:''}
      ${sec.try?`<div class="call"><b>Try:</b> ${hEsc(sec.try)}</div>`:''}
    `;
    root.appendChild(div);
  });
}

/* Specific Fortunes */
const TOPICS=[
  {key:'wealth',icon:'ğŸ’°',name:'Wealth & Money',hint:'Income, savings, timing.'},
  {key:'love',icon:'â¤ï¸',name:'Love & Relationships',hint:'Compatibility, timing.'},
  {key:'career',icon:'ğŸ§°',name:'Career & Growth',hint:'Fit, leadership vs craft.'},
  {key:'health',icon:'ğŸŒ¿',name:'Health & Wellness',hint:'Imbalance â†’ care.'},
  {key:'family',icon:'ğŸ‘¶',name:'Family & Children',hint:'Fertility & dynamics.'},
  {key:'travel',icon:'âœˆï¸',name:'Travel / Relocation',hint:'Good periods, cautions.'},
  {key:'learning',icon:'ğŸ“˜',name:'Learning & Skills',hint:'What to study.'},
  {key:'timing',icon:'â±ï¸',name:'Timing & Windows',hint:'Shortâ€‘term chances.'},
];
function mountFortuneGrid(){
  const g=Q('#fgrid'); g.innerHTML='';
  TOPICS.forEach(t=>{
    const card=document.createElement('div'); card.className='ftile'; card.dataset.key=t.key;
    card.innerHTML=`
      <div class="ftop">
        <div class="fleft">
          <div class="ficon">${t.icon}</div>
          <div>
            <div class="fname">${t.name}</div>
            <div class="fhint">${t.hint}</div>
          </div>
        </div>
        <button class="see">See insights</button>
      </div>
      <div class="fcontent"></div>
    `;
    g.appendChild(card);
  });
  S('.see').forEach(btn=>{
    btn.addEventListener('click',()=>expandTopic(btn.closest('.ftile')));
  });
}
async function expandTopic(card){
  const key=card.dataset.key, btn=card.querySelector('.see'), content=card.querySelector('.fcontent');
  btn.disabled=true; btn.textContent='Loadingâ€¦';
  try{
    const r=await getJSON(`/api/ask?topic=${encodeURIComponent(key)}`);
    if(!r.ok||!r.data?.ok) throw 0;
    const o=r.data.output||{};
    content.innerHTML=`
      <div class="block"><div class="btitle">Overview</div>${hEsc(o.overview||'')}</div>
      ${o.phases?`<div class="block"><div class="btitle">Key Phases</div>${hEsc(o.phases)}</div>`:''}
      ${o.watch?`<div class="block"><div class="btitle">Watch Out</div>${hEsc(o.watch)}</div>`:''}
      ${o.tips?`<div class="block"><div class="btitle">Tips</div>${hEsc(o.tips)}</div>`:''}
      <div class="closewrap"><button class="closebtn">Close</button></div>
    `;
    content.style.display='block';
    btn.style.display='none';
    content.querySelector('.closebtn').addEventListener('click',()=>{
      content.style.display='none'; btn.style.display='inline-block';
    });
  }catch(e){
    content.innerHTML=`<div class="block err">Network error â€” please try again.</div>`;
    content.style.display='block';
    setTimeout(()=>{content.style.display='none'},2200);
  }finally{
    btn.disabled=false; btn.textContent='See insights';
  }
}

/* Chat */
function addMsg(text,who='bot'){
  const p=document.createElement('div');
  p.className='msg '+(who==='me'?'me':'bot');
  p.textContent=text;
  Q('#chat').appendChild(p);
  const box=Q('#chat'); box.scrollTop=box.scrollHeight;
}
async function ask(q){
  addMsg(q,'me');
  try{
    const r=await getJSON('/api/ask',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({q})});
    if(!r.ok||!r.data?.ok){
      addMsg("I couldnâ€™t quite catch that. Could you rephrase your question? ğŸ™‚", 'bot'); return;
    }
    addMsg(r.data.output||"Hereâ€™s my take based on your chart.",'bot');
  }catch(e){
    addMsg("âš ï¸ Network error â€” please try again.",'bot');
  }
}

/* ===== main flow ===== */
Q('#fill').addEventListener('click',()=>{
  Q('#yy').value='1989'; Q('#mm').value='10'; Q('#dd').value='20'; Q('#hh').value='06'; Q('#min').value='00';
  Q('#city').value='seoul';
});
Q('#askBtn').addEventListener('click',()=>{
  const v=Q('#ask').value.trim(); if(!v) return; Q('#ask').value=''; ask(v);
});

Q('#run').addEventListener('click', async ()=>{
  const yy=Q('#yy').value, mm=Q('#mm').value, ddv=Q('#dd').value, hh=Q('#hh').value, mi=Q('#min').value;
  const city=Q('#city').value.trim();
  if(!city){ setStatus('Please enter a birth city.', 'err'); return; }
  const birthDateISO=`${yyyy(yy)}-${mm}-${ddv}`;
  const birthTime=`${hh}:${mi}`;
  setStatus('Step 1/3: Resolving city â†’ timezoneâ€¦');
  const geo=await getJSON(`/api/geo-timezone?city=${encodeURIComponent(city)}`);
  if(!geo.ok||!geo.data?.timezone){ setStatus('Failed on Step 1 (geo-timezone).','err'); return; }
  const {lat,lng}=geo.data.location; const tzId=geo.data.timezone;

  setStatus('Step 2/3: Calculating pillarsâ€¦');
  const calc=await getJSON('/api/calc',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({birthDateISO,birthTime,lat,lng,tzId,timeAccuracy:'exact'})});
  if(!calc.ok||!calc.data?.data){ setStatus('Failed on Step 2 (calc).','err'); return; }
  const d=calc.data.data||{}; const {pillars,elements,tenGods,hiddenStems,interactions,luck}=d;
  renderPillars(pillars,elements,tenGods,hiddenStems);
  renderLuck(luck,birthDateISO);

  setStatus('Step 3/3: Generating 6â€‘section readingâ€¦');
  const read=await getJSON('/api/reading-generate',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({pillars,elements,tenGods,interactions,type:'summary',locale:'en-US',length:'long',maxBullets:6})});
  if(!read.ok||!read.data?.output){ setStatus('Failed on Step 3 (reading).','err'); return; }
  renderReading6(read.data.output?.sections||{});

  setStatus(`Done â€¢ tz: ${tzId} â€¢ lat:${lat.toFixed(4)}, lng:${lng.toFixed(4)}`,'ok');

  // rebuild topics grid (keeps UI consistent with new context)
  mountFortuneGrid();

  // debug
  dbgEl.textContent = 'geo-timezone\n'+JSON.stringify(geo.data,null,2)+'\n\ncalc\n'+JSON.stringify(calc.data,null,2)+'\n\nreading\n'+JSON.stringify(read.data,null,2);
});

/* boot */
mountFortuneGrid();
addMsg("Hi! Ask me anything about timing, relationships, career, or health. Iâ€™ll use your current chart as context.",'bot');
</script>
  ...
<!-- ê¸°ì¡´ ìŠ¤í¬ë¦½íŠ¸ë“¤ -->
<script>/* ... your app scripts ... */</script>

<!-- â†“â†“â†“ ì—¬ê¸°ì— ê·¸ëŒ€ë¡œ ë¶™ì—¬ë„£ê¸° â†“â†“â†“ -->
<script>
/**
 * Network-safe fetchJSON + pretty error renderer (drop-in)
 * - ê¸°ì¡´ window.fetchJSONì„ ì´ ì•ˆì „ ë²„ì „ìœ¼ë¡œ êµì²´
 * - ì–´ë””ì„œë“  renderNetworkError(container, label, resp) í˜¸ì¶œ ê°€ëŠ¥
 * - resp í˜•íƒœ: { ok:boolean, status:number, data:object|null, raw:string }
 */
(function () {
  // ìŠ¤íƒ€ì¼ì´ ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ ìµœì†Œ ìŠ¤íƒ€ì¼(ìˆìœ¼ë©´ ë¬´ì‹œë¨)
  const style = document.createElement('style');
  style.textContent = `
    .sx-card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:12px}
    .sx-kicker{font-size:12px;letter-spacing:.16em;text-transform:uppercase;opacity:.7;margin-bottom:6px}
    .sx-err{color:#f8d48b}
    .sx-pre{white-space:pre-wrap;opacity:.85;margin-top:6px;background:#0b1426;border:1px solid rgba(255,255,255,.08);padding:8px;border-radius:8px;max-height:220px;overflow:auto}
  `;
  document.head.appendChild(style);

  // ê¸°ì¡´ fetchJSON ë³´ê´€(ìˆë‹¤ë©´)
  const _prevFetchJSON = window.fetchJSON;

  /**
   * ì•ˆì „í•œ fetchJSON: í•­ìƒ {ok, status, data, raw}ë¡œ ë°˜í™˜
   * - HTTP 200ì´ë”ë¼ë„ JSON íŒŒì‹± ì‹¤íŒ¨í•˜ë©´ ok=false
   * - ë„¤íŠ¸ì›Œí¬ ì˜ˆì™¸ë„ ok=false
   */
  async function safeFetchJSON(url, opts = {}) {
    try {
      const r = await fetch(url, opts);
      const text = await r.text();
      let data = null;
      try { data = JSON.parse(text); } catch { /* ignore parse error */ }
      return { ok: r.ok && !!data, status: r.status, data, raw: text };
    } catch (e) {
      return { ok: false, status: 0, data: null, raw: String(e && e.message || e) };
    }
  }

  // ì „ì—­ êµì²´ (ê¸°ì¡´ í•¨ìˆ˜ê°€ ìˆì–´ë„ ë®ì–´ì”€)
  window.fetchJSON = safeFetchJSON;

  /**
   * ì˜ˆìœ ì—ëŸ¬ í‘œì‹œê¸°
   * @param {HTMLElement} container - ì—ëŸ¬ë¥¼ í‘œì‹œí•  DOM
   * @param {string} label - ì„¹ì…˜ ë¼ë²¨(ì˜ˆ: 'READING', 'Wealth & Money')
   * @param {object} resp - fetchJSON ë°˜í™˜ ê°ì²´
   * @param {object} [opt] - ì˜µì…˜ {hint?:string}
   */
  window.renderNetworkError = function renderNetworkError(container, label, resp, opt = {}) {
    if (!container) return;
    const msg = (resp && resp.data && resp.data.error)
      || (resp && resp.raw)
      || 'Network error â€” please try again.';

    const hint = opt.hint
      ? `<div style="margin-top:8px;opacity:.75">${opt.hint}</div>`
      : '';

    container.innerHTML = `
      <div class="sx-card" style="border-color:#f59e0b80">
        <div class="sx-kicker">${label || 'ERROR'}</div>
        <div class="sx-err">Network / Server error</div>
        ${resp?.status ? `<div style="opacity:.8;margin-top:4px">status: ${resp.status}</div>` : ''}
        <div class="sx-pre">${String(msg).slice(0, 1200)}</div>
        ${hint}
      </div>
    `;
  };

  /**
   * í¸ì˜ í•¨ìˆ˜: ì‹¤íŒ¨ ì‘ë‹µì´ë©´ ìë™ ë Œë”ë§
   * @param {HTMLElement} container
   * @param {string} label
   * @param {object} resp
   * @returns {boolean} trueë©´ ì—ëŸ¬ ë Œë”ë§ ì™„ë£Œ(ìƒìœ„ ë¡œì§ ì¤‘ë‹¨), falseë©´ ê³„ì† ì§„í–‰
   */
  window.renderErrorIfNeeded = function (container, label, resp) {
    if (!resp || !resp.ok || (resp.data && resp.data.ok === false)) {
      window.renderNetworkError(container, label, resp);
      return true;
    }
    return false;
  };

  /**
   * ì „ì—­ ë¯¸ì²˜ë¦¬ ì˜ˆì™¸/Promise ê±°ë¶€ë¥¼ ì½˜ì†”ê³¼ í† ìŠ¤íŠ¸ë¡œ ì•Œë ¤ì¤Œ(ì„ íƒ)
   * ì›ì¹˜ ì•Šìœ¼ë©´ ì•„ë˜ ë¦¬ìŠ¤ë„ˆ ë‘˜ì„ ì§€ì›Œë„ ë¨.
   */
  function toast(msg) {
    try {
      const el = document.createElement('div');
      el.textContent = msg;
      el.style.cssText = `
        position:fixed;left:50%;transform:translateX(-50%);
        bottom:20px;max-width:90vw;z-index:99999;
        background:#2b1b1b;color:#ffd7d7;border:1px solid #ff7a7a66;
        padding:8px 12px;border-radius:8px;font-size:12px;opacity:.98
      `;
      document.body.appendChild(el);
      setTimeout(()=>el.remove(), 3500);
    } catch {}
  }
  window.addEventListener('unhandledrejection', (e) => {
    console.error('[Unhandled rejection]', e.reason);
    toast('A background error occurred. Check console.');
  });
  window.addEventListener('error', (e) => {
    console.error('[Window error]', e.error || e.message);
    // toast('A script error occurred. Check console.');
  });

  // ë””ë²„ê·¸ í—¬í¼: ìµœê·¼ ì‹¤íŒ¨ ì‘ë‹µì„ ì €ì¥(í•„ìš” ì‹œ ì½˜ì†”ì—ì„œ í™•ì¸)
  window.__lastApiError = null;
  const _fetchJSONProbe = window.fetchJSON;
  window.fetchJSON = async function wrappedFetchJSON(url, opts) {
    const r = await _fetchJSONProbe(url, opts);
    if (!r.ok || (r.data && r.data.ok === false)) {
      window.__lastApiError = { url, opts, resp: r };
    }
    return r;
  };

  // ì‚¬ìš© ê°€ì´ë“œ(ì½˜ì†”ì— 1íšŒ)
  try {
    console.info(
      '[Saju Error Helper] fetchJSON patched. Use renderNetworkError(container, label, resp) when resp.ok === false.'
    );
  } catch {}
})();
</script>
</body>
</html>
